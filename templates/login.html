<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRANPIX - Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* TEMA GLOBAL: Branco, Preto e Vermelho */
        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #000 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif;
        }

        .login-container {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            padding: 60px 40px;
            border: 3px solid #dc143c;
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo h1 {
            font-size: 48px;
            color: #dc143c;
            margin: 0;
            font-weight: bold;
        }

        .logo p {
            color: #666;
            margin-top: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .nav-tabs {
            border-bottom: 3px solid #000;
            margin-bottom: 40px;
        }

        .nav-tabs .nav-link {
            color: #666;
            border: none;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-tabs .nav-link:hover {
            color: #dc143c;
            border-bottom: 3px solid #dc143c;
            margin-bottom: -3px;
        }

        .nav-tabs .nav-link.active {
            color: #dc143c;
            background: transparent;
            border-bottom: 3px solid #dc143c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: 600;
            color: #000;
            margin-bottom: 8px;
        }

        .form-control {
            border: 2px solid #000;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            transition: all 0.3s;
            background: #fff;
            color: #000;
        }

        .form-control:focus {
            border-color: #dc143c;
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.2);
            outline: none;
        }

        .form-control::placeholder {
            color: #999;
        }

        .btn-login {
            width: 100%;
            padding: 12px;
            border: 2px solid #000;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            background: #000;
            color: white;
        }

        .btn-login:hover:not(:disabled) {
            background: #dc143c;
            border-color: #dc143c;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 20, 60, 0.3);
        }

        .btn-login:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .alert {
            border-radius: 8px;
            border: 2px solid #dc143c;
            margin-bottom: 20px;
            display: none;
            background: #fff;
            color: #dc143c;
        }

        .alert.show {
            display: block;
        }

        .alert-danger {
            border-color: #dc143c !important;
            background: #fff !important;
            color: #dc143c !important;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            border-top-color: #dc143c;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .equipe-select {
            margin-bottom: 20px;
        }

        select {
            width: 100%;
        }

        .nav-pills .nav-link {
            color: #666;
            background: transparent;
            border-bottom: 2px solid transparent;
            padding: 12px 16px;
            font-weight: 600;
        }

        .nav-pills .nav-link:hover {
            color: #dc143c;
            border-bottom-color: #dc143c;
        }

        .nav-pills .nav-link.active {
            background: transparent;
            color: #dc143c;
            border-bottom: 2px solid #dc143c;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">
            <h1>üèéÔ∏è GRANPIX</h1>
            <p>Sistema de Corridas</p>
        </div>

        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="equipe-tab" data-bs-toggle="tab" data-bs-target="#equipe-login" type="button" role="tab">
                    Equipe
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="piloto-tab" data-bs-toggle="tab" data-bs-target="#piloto-login" type="button" role="tab">
                    Piloto
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin-login" type="button" role="tab">
                    Admin
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- LOGIN EQUIPE -->
            <div class="tab-pane fade show active" id="equipe-login" role="tabpanel">
                <div class="alert alert-danger" id="erroEquipe"></div>

                <div class="form-group">
                    <label class="form-label">Selecione sua Equipe</label>
                    <select class="form-control" id="equipeSelecionada">
                        <option value="">Carregando equipes...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-control" id="senhaEquipe" placeholder="Digite sua senha">
                </div>

                <button class="btn-login" id="btnLoginEquipe" onclick="loginEquipe()">
                    Entrar
                </button>
            </div>

            <!-- LOGIN PILOTO -->
            <div class="tab-pane fade" id="piloto-login" role="tabpanel">
                <div class="alert alert-danger" id="erroPiloto"></div>

                <!-- NAV PARA CADASTRO/LOGIN -->
                <ul class="nav nav-pills" role="tablist" style="margin-bottom: 20px;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="piloto-login-tab" data-bs-toggle="tab" data-bs-target="#piloto-login-form" type="button" role="tab">
                            Entrar
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="piloto-cadastro-tab" data-bs-toggle="tab" data-bs-target="#piloto-cadastro-form" type="button" role="tab">
                            Cadastrar
                        </button>
                    </li>
                </ul>

                <!-- LOGIN PILOTO -->
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="piloto-login-form" role="tabpanel">
                        <div class="form-group">
                            <label class="form-label">Nome do Piloto</label>
                            <input type="text" class="form-control" id="nomePiloto" placeholder="Digite seu nome">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Senha</label>
                            <input type="password" class="form-control" id="senhaPiloto" placeholder="Digite sua senha">
                        </div>

                        <button class="btn-login" id="btnLoginPiloto" onclick="loginPiloto()">
                            Entrar
                        </button>
                    </div>

                    <!-- CADASTRO PILOTO -->
                    <div class="tab-pane fade" id="piloto-cadastro-form" role="tabpanel">
                        <div class="form-group">
                            <label class="form-label">Nome do Piloto</label>
                            <input type="text" class="form-control" id="nomePilatoCadastro" placeholder="Escolha um nome">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Senha</label>
                            <input type="password" class="form-control" id="senhaPilatoCadastro" placeholder="Escolha uma senha">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Confirmar Senha</label>
                            <input type="password" class="form-control" id="confirmarSenhaPilato" placeholder="Confirme a senha">
                        </div>

                        <button class="btn-login" id="btnCadastroPiloto" onclick="cadastroPiloto()">
                            Cadastrar
                        </button>
                    </div>
                </div>
            </div>

            <!-- LOGIN ADMIN -->
            <div class="tab-pane fade" id="admin-login" role="tabpanel">
                <div class="alert alert-danger" id="erroAdmin"></div>

                <div class="form-group">
                    <label class="form-label">Senha Admin</label>
                    <input type="password" class="form-control" id="senhaAdmin" placeholder="Digite a senha de admin">
                </div>

                <button class="btn-login" id="btnLoginAdmin" onclick="loginAdmin()">
                    Acessar Painel
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Carregar equipes ao abrir p√°gina
        window.addEventListener('load', carregarEquipes);

        async function carregarEquipes() {
            try {
                const resp = await fetch('/api/equipes');
                const equipes = await resp.json();
                
                const select = document.getElementById('equipeSelecionada');
                select.innerHTML = '';
                
                equipes.forEach(eq => {
                    const option = document.createElement('option');
                    option.value = eq.id;
                    option.textContent = `${eq.nome} (Saldo: ${formatarMoeda(eq.saldo)})`;
                    select.appendChild(option);
                });
            } catch (e) {
                console.log('Erro ao carregar equipes');
            }
        }

        async function loginEquipe() {
            const equipe_idx = document.getElementById('equipeSelecionada').value;
            const senha = document.getElementById('senhaEquipe').value;
            const btn = document.getElementById('btnLoginEquipe');
            const erroDiv = document.getElementById('erroEquipe');

            if (!equipe_idx || !senha) {
                mostrarErro('Por favor, preencha todos os campos', erroDiv);
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Autenticando...';

            try {
                const resp = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        tipo: 'equipe',
                        equipe_id: equipe_idx,  // UUID string, n√£o inteiro
                        senha: senha
                    })
                });

                const resultado = await resp.json();

                if (resultado.sucesso) {
                    // resultado.uuid cont√©m o UUID real da equipe
                    // Armazenar no localStorage o UUID real
                    localStorage.setItem('equipe_id', resultado.uuid);
                    localStorage.setItem('equipe_nome', resultado.nome);
                    
                    // Verificar se h√° etapa em andamento
                    try {
                        const etapaResp = await fetch('/api/etapa-em-andamento');
                        if (etapaResp.ok) {
                            const etapaData = await etapaResp.json();
                            if (etapaData.sucesso && etapaData.etapa) {
                                // Redirecionar com etapa_id na URL
                                window.location.href = `/dashboard?etapa=${etapaData.etapa.id}`;
                                return;
                            }
                        }
                    } catch (e) {
                        console.log('Erro ao verificar etapa em andamento:', e);
                    }
                    
                    // Redirecionar para dashboard (sem etapa)
                    window.location.href = '/dashboard';
                } else {
                    mostrarErro(resultado.erro, erroDiv);
                }
            } catch (e) {
                mostrarErro('Erro ao conectar com o servidor', erroDiv);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Entrar';
            }
        }

        async function loginAdmin() {
            const senha = document.getElementById('senhaAdmin').value;
            const btn = document.getElementById('btnLoginAdmin');
            const erroDiv = document.getElementById('erroAdmin');

            if (!senha) {
                mostrarErro('Por favor, digite a senha', erroDiv);
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Autenticando...';

            try {
                const resp = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        tipo: 'admin',
                        senha: senha
                    })
                });

                const resultado = await resp.json();

                if (resultado.sucesso) {
                    // Salvar na sessionStorage que admin est√° logado
                    sessionStorage.setItem('admin_logado', 'true');
                    
                    // Verificar se h√° etapa em andamento
                    try {
                        const etapaResp = await fetch('/api/etapa-em-andamento');
                        if (etapaResp.ok) {
                            const etapaData = await etapaResp.json();
                            if (etapaData.sucesso && etapaData.etapa) {
                                // Redirecionar com etapa_id na URL
                                window.location.href = `/admin/solicitacoes-pecas?etapa=${etapaData.etapa.id}`;
                                return;
                            }
                        }
                    } catch (e) {
                        console.log('Erro ao verificar etapa em andamento:', e);
                    }
                    
                    // Redirecionar para admin (sem etapa)
                    window.location.href = '/admin/solicitacoes-pecas';
                } else {
                    mostrarErro(resultado.erro, erroDiv);
                }
            } catch (e) {
                mostrarErro('Erro ao conectar com o servidor', erroDiv);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Acessar Painel';
            }
        }

        function mostrarErro(msg, div) {
            div.textContent = '‚ùå ' + msg;
            div.classList.add('show');
            setTimeout(() => div.classList.remove('show'), 5000);
        }

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        // Enter para submeter
        document.getElementById('senhaEquipe').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginEquipe();
        });

        document.getElementById('senhaAdmin').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginAdmin();
        });

        document.getElementById('senhaPiloto').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginPiloto();
        });

        // Fun√ß√µes de Piloto
        async function loginPiloto() {
            const nome = document.getElementById('nomePiloto').value;
            const senha = document.getElementById('senhaPiloto').value;
            const btn = document.getElementById('btnLoginPiloto');
            const erroDiv = document.getElementById('erroPiloto');

            if (!nome || !senha) {
                mostrarErro('Por favor, preencha todos os campos', erroDiv);
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Autenticando...';

            try {
                const resp = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        tipo: 'piloto',
                        nome: nome,
                        senha: senha
                    })
                });

                const resultado = await resp.json();

                if (resultado.sucesso) {
                    localStorage.setItem('piloto_id', resultado.piloto_id);
                    localStorage.setItem('piloto_nome', resultado.nome);
                    localStorage.removeItem('equipe_id'); // Limpar equipe se houver
                    
                    // Verificar se h√° etapa em andamento
                    try {
                        const etapaResp = await fetch('/api/etapa-em-andamento');
                        if (etapaResp.ok) {
                            const etapaData = await etapaResp.json();
                            if (etapaData.sucesso && etapaData.etapa) {
                                // Redirecionar com etapa_id na URL
                                window.location.href = `/campeonato?etapa=${etapaData.etapa.id}`;
                                return;
                            }
                        }
                    } catch (e) {
                        console.log('Erro ao verificar etapa em andamento:', e);
                    }
                    
                    // Redirecionar para campeonato (sem etapa)
                    window.location.href = '/campeonato';
                } else {
                    mostrarErro(resultado.erro, erroDiv);
                }
            } catch (e) {
                mostrarErro('Erro ao conectar com o servidor', erroDiv);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Entrar';
            }
        }

        async function cadastroPiloto() {
            const nome = document.getElementById('nomePilatoCadastro').value;
            const senha = document.getElementById('senhaPilatoCadastro').value;
            const confirma = document.getElementById('confirmarSenhaPilato').value;
            const btn = document.getElementById('btnCadastroPiloto');
            const erroDiv = document.getElementById('erroPiloto');

            if (!nome || !senha || !confirma) {
                mostrarErro('Por favor, preencha todos os campos', erroDiv);
                return;
            }

            if (senha !== confirma) {
                mostrarErro('As senhas n√£o coincidem', erroDiv);
                return;
            }

            if (senha.length < 4) {
                mostrarErro('Senha deve ter pelo menos 4 caracteres', erroDiv);
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Cadastrando...';

            try {
                const resp = await fetch('/api/pilotos/cadastrar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nome: nome,
                        senha: senha
                    })
                });

                const resultado = await resp.json();

                if (resultado.sucesso) {
                    mostrarErro('‚úÖ Cadastro realizado! Fa√ßa login na aba Entrar', erroDiv);
                    // Limpar campos
                    document.getElementById('nomePilatoCadastro').value = '';
                    document.getElementById('senhaPilatoCadastro').value = '';
                    document.getElementById('confirmarSenhaPilato').value = '';
                    
                    // Voltar para aba de login
                    setTimeout(() => {
                        document.getElementById('piloto-login-tab').click();
                    }, 2000);
                } else {
                    mostrarErro(resultado.erro, erroDiv);
                }
            } catch (e) {
                mostrarErro('Erro ao cadastrar: ' + e.message, erroDiv);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Cadastrar';
            }
        }
    </script>
</body>
</html>
