<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GRANPIX - Cadastrar Carros</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.0/imask.min.js"></script>
  <style>
    .sidebar {
      position: fixed;
      top: 56px;
      left: 0;
      width: 250px;
      height: calc(100vh - 56px);
      background-color: #343a40;
      padding-top: 20px;
      overflow-y: auto;
      z-index: 1000;
    }
    
    .sidebar .nav-link {
      color: #adb5bd;
      padding: 10px 20px;
      margin: 5px 10px;
      border-radius: 5px;
      transition: all 0.3s;
    }
    
    .sidebar .nav-link:hover {
      color: #fff;
      background-color: #495057;
    }
    
    .sidebar .nav-link.active {
      color: #fff;
      background-color: #dc143c;
    }
    
    .main-content {
      margin-left: 250px;
      padding: 20px;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        top: 0;
      }
      .main-content {
        margin-left: 0;
      }
    }

    #modalDesignarPiloto {
      pointer-events: auto !important;
      z-index: 9999 !important;
    }
    
    #modalDesignarPiloto * {
      pointer-events: auto !important;
    }
    
    #modalDesignarPiloto .modal-dialog {
      pointer-events: auto !important;
    }
    
    #modalDesignarPiloto .modal-content {
      pointer-events: auto !important;
    }

    #modalConfirmacaoAlocacao {
      pointer-events: auto !important;
      z-index: 9999 !important;
      display: none !important;
    }

    #modalConfirmacaoAlocacao.show {
      display: block !important;
    }

    #modalConfirmacaoAlocacao * {
      pointer-events: auto !important;
    }

    #modalConfirmacaoAlocacao .modal-dialog {
      pointer-events: auto !important;
    }

    #modalConfirmacaoAlocacao .modal-content {
      pointer-events: auto !important;
    }

    #modalConfirmacaoAlocacao .btn {
      pointer-events: auto !important;
    }
    
    .modal-backdrop {
      pointer-events: auto !important;
      z-index: 9998 !important;
    }
  </style>
  <!-- Carregar script.js primeiro para definir funções globais -->
  <script src="{{ url_for('static', filename='script.js') }}"></script>
  <!-- Depois carregar qualificacao.js que usa funções de script.js -->
  <script src="{{ url_for('static', filename='qualificacao.js') }}"></script>
  <!-- Por fim, sistema_notificacao que usa funções de qualificacao.js -->
  <script src="{{ url_for('static', filename='sistema_notificacao.js') }}"></script>
</head>
<body>
  <nav class="navbar navbar-dark" style="background-color: #1a1a1a; border-bottom: 3px solid #dc143c;">
  <div class="container-fluid">
  <span class="navbar-brand mb-0 h1" style="color: #dc143c; font-weight: bold;">GRANPIX - Painel Administrativo</span>
  <a href="/" class="btn btn-sm btn-outline-light">Voltar ao Site</a>
  </div>
  </nav>

  <!-- Sidebar -->
  <div class="sidebar">
  <nav class="nav flex-column">
  <a class="nav-link active" href="/admin/carros">
  <i class="fas fa-car"></i> Cadastrar Carros
  </a>
  <a class="nav-link" href="/admin/pecas">
  <i class="fas fa-cogs"></i> Cadastrar Peças
  </a>
  <a class="nav-link" href="/admin/variacoes">
  <i class="fas fa-tools"></i> Cadastrar Variações
  </a>
  <a class="nav-link" href="/admin/equipes">
  <i class="fas fa-users"></i> Cadastrar Equipes
  </a>
  <a class="nav-link" href="/admin/etapas">
  <i class="fas fa-calendar"></i> Gerenciar Etapas
  </a>
  <a class="nav-link" href="/admin/solicitacoes-pecas">
  <i class="fas fa-clipboard-list"></i> Solicitações de Peças
  </a>
  <a class="nav-link" href="/admin/solicitacoes-carros">
  <i class="fas fa-clipboard-check"></i> Solicitações de Carros
  </a>
  <a class="nav-link" href="/admin/fazer-etapa">
  <i class="fas fa-play"></i> Fazer Etapa
  </a>
  <a class="nav-link" href="/admin/alocar-pilotos">
  <i class="fas fa-user-check"></i> Alocar Pilotos
  </a>
  <a class="nav-link" href="/admin/comissoes">
  <i class="fas fa-money-bill"></i> Comissões
  </a>
  <a class="nav-link" href="/admin/configuracoes">
  <i class="fas fa-cog"></i> Configurações
  </a>
  <a class="nav-link" href="/admin/equipes-list">
  <i class="fas fa-list"></i> Lista de Equipes
  </a>
  </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
  <div class="container-fluid mt-4">
  <div class="row mb-4">
  <div class="col-md-3">
  <div class="stat-card">
  <div class="stat-label">Total de Equipes</div>
  <div class="stat-value" id="totalEquipes">-</div>
  </div>
  </div>
  <div class="col-md-3">
  <div class="stat-card">
  <div class="stat-label">Solicitações de Peça</div>
  <div class="stat-value" id="solicitacoesPecasPendentes">0</div>
  </div>
  </div>
  <div class="col-md-3">
  <div class="stat-card">
  <div class="stat-label">Solicitações de Carro</div>
  <div class="stat-value" id="solicitacoesCarrosPendentes">0</div>
  </div>
  </div>
  </div>
  <div class="row">
  <div class="col-md-6">
  <div class="card">
  <div class="card-header bg-dark text-white">
  <h5 class="mb-0">Novo Carro</h5>
  </div>
  <div class="card-body">
  <div class="form-group">
  <label>Modelo</label>
  <input type="text" class="form-control" id="carroModelo"
  placeholder="Ex: Ferrari F40">
  </div>
  <div class="form-group">
  <label>Marca</label>
  <input type="text" class="form-control" id="carroMarca" placeholder="Ex: Ferrari">
  </div>
  <div class="form-group">
  <label>Preço</label>
  <input type="number" class="form-control" id="carroPreco" placeholder="Ex: 50000"
  step="0.01">
  </div>
  <div class="form-group">
  <label>Imagem (opcional)</label>
  <input type="file" class="form-control" id="carroImagem" accept="image/*">
  <small class="text-muted d-block mt-2">Selecione uma imagem para o carro (PNG, JPG, etc)</small>
  <div id="carroImagemPreview" style="margin-top: 10px;">
  <img id="carroImagemPreviewImg" style="max-width: 100%; max-height: 150px; display: none;">
  </div>
  </div>
  <button class="btn btn-primary w-100" type="button" onclick="window.cadastrarCarro()">
  Cadastrar Carro
  </button>
  </div>
  </div>
  </div>
  <div class="col-md-6">
  <div class="card">
  <div class="card-header bg-dark text-white">
  <h5 class="mb-0">Carros Cadastrados</h5>
  </div>
  <div class="card-body" id="listaCarros" style="max-height: 500px; overflow-y: auto;">
  <p class="text-muted">Carregando...</p>
  </div>
  </div>
  </div>
  </div>
  </div>
  </div>
  <div class="modal fade" id="modalEditarCarro" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
  <div class="modal-content">
  <div class="modal-header bg-dark text-white">
  <h5 class="modal-title">Editar Carro</h5>
  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
  </div>
  <div class="modal-body">
  <input type="hidden" id="editCarroId">
  <div class="form-group">
  <label>Marca</label>
  <input type="text" class="form-control" id="editCarroMarca">
  </div>
  <div class="form-group">
  <label>Modelo</label>
  <input type="text" class="form-control" id="editCarroModelo">
  </div>
  <div class="form-group">
  <label>Preço</label>
  <input type="number" class="form-control" id="editCarroPreco" step="0.01">
  </div>
  <div class="form-group">
  <label>Imagem</label>
  <div id="editCarroImagemAtual" style="margin-bottom: 10px;">
  <img id="editCarroImagemAtualImg" style="max-width: 100%; max-height: 150px; display: none;" alt="Imagem atual">
  </div>
  <input type="file" class="form-control" id="editCarroImagem" accept="image/*">
  <small class="text-muted d-block mt-2">Selecione uma nova imagem para substituir (opcional)</small>
  <button type="button" class="btn btn-sm btn-danger mt-2" id="editCarroDeletarImagemBtn" style="display: none;">
    Deletar Imagem
  </button>
  </div>
  </div>
  <div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
  <button type="button" class="btn btn-danger" onclick="window.deletarCarro()">Deletar Carro</button>
  <button type="button" class="btn btn-primary" onclick="window.salvarEdicaoCarro()">Salvar</button>
  </div>
  </div>
  </div>
  </div>
  <div class="toast-container"></div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  // Verificar autenticação de admin
  if (!sessionStorage.getItem('admin_logado')) {
  // Se não tem sessão de admin, redireciona para login
  // Mas permite carregar para testar
  }
  // Variáveis globais para controlar auto-refresh
  let intervaloSolicitacoesPecas = null;
  let intervaloSolicitacoesCarros = null;
  let intervaloContadores = null;
  let abaSolicitacoesPecasAtiva = true;
  let abaSolicitacoesCarrosAtiva = false;
  // Função auxiliar para ler arquivo como Base64
  function lerArquivoComoBase64(arquivo) {
  return new Promise((resolve, reject) => {
  const reader = new FileReader();
  reader.onload = () => resolve(reader.result);
  reader.onerror = reject;
  reader.readAsDataURL(arquivo);
  });
  }
  // Cadastrar carro: definido em window no início para o onclick do botão sempre resolver
  window.cadastrarCarro = async function() {
  var marca = document.getElementById('carroMarca') && document.getElementById('carroMarca').value ? document.getElementById('carroMarca').value.trim() : '';
  var modelo = document.getElementById('carroModelo') && document.getElementById('carroModelo').value ? document.getElementById('carroModelo').value.trim() : '';
  var preco = document.getElementById('carroPreco') && document.getElementById('carroPreco').value ? document.getElementById('carroPreco').value.trim() : '';
  var inputImagem = document.getElementById('carroImagem');
  if (!modelo || !marca) { alert('Preencha Marca e Modelo.'); return; }
  if (!preco || isNaN(parseFloat(preco))) { alert('Preencha um Preço válido.'); return; }
  var payload = { marca: marca, modelo: modelo, preco: preco, classe: 'basico', descricao: marca + ' ' + modelo };
  if (inputImagem && inputImagem.files && inputImagem.files.length) {
  try { payload.imagem = (await lerArquivoComoBase64(inputImagem.files[0])).split(',')[1] || ''; } catch (e) { console.warn('Imagem ignorada:', e); }
  }
  try {
  var r = await fetch('/api/admin/cadastrar-carro', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  var data = await r.json();
  if (data.sucesso) {
  document.getElementById('carroMarca').value = ''; document.getElementById('carroModelo').value = ''; document.getElementById('carroPreco').value = '';
  if (inputImagem) inputImagem.value = '';
  if (typeof carregarCarros === 'function') carregarCarros();
  alert('Carro cadastrado com sucesso.');
  } else { alert('Erro: ' + (data.erro || 'Erro ao cadastrar')); }
  } catch (e) { alert('Erro ao cadastrar: ' + e.message); }
  };
  // Função para verificar se existe modal aberto
  function temModalAbertoAdmin() {
  return document.querySelectorAll('.modal.show').length > 0;
  }
  // Função para iniciar auto-refresh
  function iniciarAutoRefreshAdmin() {
  // Auto-refresh das solicitações de Peças
  intervaloSolicitacoesPecas = setInterval(() => {
  if (abaSolicitacoesPecasAtiva && !document.hidden && !temModalAbertoAdmin()) {
  carregarSolicitacoes();
  }
  }, 3000);
  // Auto-refresh das solicitações de carros
  intervaloSolicitacoesCarros = setInterval(() => {
  if (abaSolicitacoesCarrosAtiva && !document.hidden && !temModalAbertoAdmin()) {
  carregarSolicitacoesCarros();
  }
  }, 3000);
  // Auto-refresh dos contadores de solicitações pendentes
  intervaloContadores = setInterval(() => {
  if (!document.hidden && !temModalAbertoAdmin()) {
  atualizarContadoresSolicitacoes().catch(e => {
  console.error('Erro no intervalo de contadores:', e);
  });
  }
  }, 3000);
  }
  // Função para parar auto-refresh
  function pararAutoRefreshAdmin() {
  if (intervaloSolicitacoesPecas) clearInterval(intervaloSolicitacoesPecas);
  if (intervaloSolicitacoesCarros) clearInterval(intervaloSolicitacoesCarros);
  if (intervaloContadores) clearInterval(intervaloContadores);
  }
  // Inicializar painel
  window.addEventListener('load', () => {
  atualizarStatusAdmin();
  atualizarContadoresSolicitacoes().catch(e => console.error('Erro ao atualizar contadores:', e));
  carregarCarros();
  // Iniciar auto-refresh
  iniciarAutoRefreshAdmin();
  });
  async function atualizarStatusAdmin() {
  try {
  console.log('Atualizando status admin...');
  const resp = await fetch('/api/admin/status');
  const status = await resp.json();
  console.log('Status recebido:', status);
  document.getElementById('totalEquipes').textContent = status.total_equipes || 0;
  } catch (e) {
  console.log('Erro ao atualizar status');
  }
  }
  async function atualizarContadoresSolicitacoes() {
  try {
  // Contar solicitações de peça pendentes
  const respPecas = await fetch('/api/admin/solicitacoes-pecas');
  const pecas = await respPecas.json();
  const pecasPendentes = Array.isArray(pecas)
  ? pecas.filter(s => s.status === 'pendente').length
  : 0;
  const elemPecas = document.getElementById('solicitacoesPecasPendentes');
  if (elemPecas) {
  elemPecas.textContent = pecasPendentes;
  }
  // Contar solicitações de carro pendentes
  const respCarros = await fetch('/api/admin/solicitacoes-carros');
  const carros = await respCarros.json();
  const carrosPendentes = Array.isArray(carros)
  ? carros.filter(s => s.status === 'pendente').length
  : 0;
  const elemCarros = document.getElementById('solicitacoesCarrosPendentes');
  if (elemCarros) {
  elemCarros.textContent = carrosPendentes;
  }
  } catch (e) {
  console.error('Erro ao atualizar contadores de solicitações:', e);
  }
  }
  async function carregarCarros() {
  try {
  console.log('Carregando carros...');
  const resp = await fetch('/api/admin/carros');
  const data = await resp.json();
  console.log('Carros recebidos:', data);
  const lista = document.getElementById('listaCarros');
  lista.innerHTML = '';
  // Verificar se é um erro
  if (data.erro || !Array.isArray(data)) {
  lista.innerHTML = '<p class="text-muted">Nenhum carro cadastrado</p>';
  return;
  }
  if (data.length === 0) {
  lista.innerHTML = '<p class="text-muted">Nenhum carro cadastrado</p>';
  return;
  }
  data.forEach((carro, idx) => {
  const div = document.createElement('div');
  div.className = 'mb-3 p-2 border rounded bg-light d-flex justify-content-between align-items-start gap-3';
  // Coluna de imagem (se existir)
  if (carro.imagem) {
  const imgCol = document.createElement('div');
  imgCol.style.flexShrink = '0';
  imgCol.innerHTML = `<img src="${carro.imagem}" style="width: 80px; height: 60px; object-fit: cover; border-radius: 4px;" alt="${carro.marca} ${carro.modelo}">`;
  div.appendChild(imgCol);
  }
  const carroInfo = document.createElement('div');
  carroInfo.style.flex = '1';
  carroInfo.innerHTML = `
  <strong>[${idx + 1}] ${carro.marca} ${carro.modelo}</strong>
  <small class="d-block text-success fw-bold">${formatarMoeda(carro.preco)}</small>
  `;
  const botao = document.createElement('button');
  botao.className = 'btn btn-sm btn-warning ms-2';
  botao.textContent = ' Editar';
  botao.onclick = () => abrirEdicaoCarro(carro);
  div.appendChild(carroInfo);
  div.appendChild(botao);
  lista.appendChild(div);
  });
  } catch (e) {
  document.getElementById('listaCarros').innerHTML = '<p class="text-danger">Erro ao carregar: ' + e.message + '</p>';
  }
  }
  async function cadastrarCarro() {
  const marca = document.getElementById('carroMarca')?.value?.trim() || '';
  const modelo = document.getElementById('carroModelo')?.value?.trim() || '';
  const preco = document.getElementById('carroPreco')?.value?.trim() || '';
  const inputImagem = document.getElementById('carroImagem');
  if (!modelo || !marca) {
  alert('Preencha Marca e Modelo.');
  return;
  }
  if (!preco || isNaN(parseFloat(preco))) {
  alert('Preencha um Preço válido.');
  return;
  }
  const payload = { marca, modelo, preco, classe: 'basico', descricao: marca + ' ' + modelo };
  if (inputImagem?.files?.length) {
  try {
  payload.imagem = (await lerArquivoComoBase64(inputImagem.files[0])).split(',')[1] || '';
  } catch (e) {
  console.warn('Imagem ignorada:', e);
  }
  }
  try {
  const r = await fetch('/api/admin/cadastrar-carro', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(payload)
  });
  const data = await r.json();
  if (data.sucesso) {
  document.getElementById('carroMarca').value = '';
  document.getElementById('carroModelo').value = '';
  document.getElementById('carroPreco').value = '';
  if (inputImagem) inputImagem.value = '';
  carregarCarros();
  alert('Carro cadastrado com sucesso.');
  } else {
  alert('Erro: ' + (data.erro || 'Erro ao cadastrar'));
  }
  } catch (e) {
  alert('Erro ao cadastrar: ' + e.message);
  }
  }
  function abrirEdicaoCarro(carro) {
  document.getElementById('editCarroId').value = carro.id || '';
  document.getElementById('editCarroMarca').value = carro.marca || '';
  document.getElementById('editCarroModelo').value = carro.modelo || '';
  document.getElementById('editCarroPreco').value = carro.preco ?? '';
  const imgEl = document.getElementById('editCarroImagemAtualImg');
  if (imgEl) {
  if (carro.imagem) {
  imgEl.src = carro.imagem.startsWith('data:') ? carro.imagem : 'data:image/jpeg;base64,' + carro.imagem;
  imgEl.style.display = 'block';
  } else {
  imgEl.src = '';
  imgEl.style.display = 'none';
  }
  const btnDel = document.getElementById('editCarroDeletarImagemBtn');
  if (btnDel) btnDel.style.display = carro.imagem ? 'inline-block' : 'none';
  }
  document.getElementById('editCarroImagem').value = '';
  const modal = new bootstrap.Modal(document.getElementById('modalEditarCarro'));
  modal.show();
  }
  async function salvarEdicaoCarro() {
  const id = document.getElementById('editCarroId')?.value;
  const marca = document.getElementById('editCarroMarca')?.value?.trim() || '';
  const modelo = document.getElementById('editCarroModelo')?.value?.trim() || '';
  const preco = document.getElementById('editCarroPreco')?.value?.trim() || '';
  if (!id) { alert('ID do carro não encontrado.'); return; }
  if (!marca || !modelo) { alert('Preencha Marca e Modelo.'); return; }
  if (!preco || isNaN(parseFloat(preco))) { alert('Preço inválido.'); return; }
  const payload = { id, marca, modelo, preco };
  const inputNovaImagem = document.getElementById('editCarroImagem');
  if (inputNovaImagem?.files?.length) {
  try {
  payload.imagem = (await lerArquivoComoBase64(inputNovaImagem.files[0])).split(',')[1] || '';
  } catch (e) { console.warn('Nova imagem ignorada:', e); }
  }
  try {
  const r = await fetch('/api/admin/editar-carro', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  const data = await r.json();
  if (data.sucesso) {
  bootstrap.Modal.getInstance(document.getElementById('modalEditarCarro'))?.hide();
  carregarCarros();
  alert('Carro atualizado.');
  } else {
  alert('Erro: ' + (data.erro || 'Erro ao salvar'));
  }
  } catch (e) {
  alert('Erro ao salvar: ' + e.message);
  }
  }
  async function deletarCarro() {
  const id = document.getElementById('editCarroId')?.value;
  if (!id) return;
  if (!confirm('Tem certeza que deseja deletar este carro?')) return;
  try {
  const r = await fetch('/api/admin/deletar-carro', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) });
  const data = await r.json();
  if (data.sucesso) {
  bootstrap.Modal.getInstance(document.getElementById('modalEditarCarro'))?.hide();
  carregarCarros();
  alert('Carro deletado.');
  } else {
  alert('Erro: ' + (data.erro || ''));
  }
  } catch (e) {
  alert('Erro ao deletar: ' + e.message);
  }
  }
  window.cadastrarCarro = cadastrarCarro;
  window.abrirEdicaoCarro = abrirEdicaoCarro;
  window.salvarEdicaoCarro = salvarEdicaoCarro;
  window.deletarCarro = deletarCarro;
  </script>
  <script>
    function deletarImagemCarro() {
      // Opcional: chamar API para remover imagem do carro em edição
      const id = document.getElementById('editCarroId')?.value;
      if (id) {
        document.getElementById('editCarroImagemAtualImg').src = '';
        document.getElementById('editCarroImagemAtualImg').style.display = 'none';
        document.getElementById('editCarroDeletarImagemBtn').style.display = 'none';
      }
    }
  </script>
  <!-- Verificar URL para abrir evento automaticamente após login (apenas para não-admins) -->
  <script>
    window.addEventListener('load', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const etapaId = urlParams.get('etapa');
      
      if (etapaId) {
        // Verificar se é admin - admins não devem abrir evento automaticamente
        try {
          const adminResp = await fetch('/api/user/is-admin');
          if (adminResp.ok) {
            const adminData = await adminResp.json();
            if (adminData.is_admin) {
              console.log('[AUTO-EVENTO] Admin detectado - ignorando abertura automática de evento');
              // Limpar URL para não reabrir o modal ao atualizar
              window.history.replaceState({}, document.title, '/admin');
              return;
            }
          }
        } catch (e) {
          console.log('[AUTO-EVENTO] Erro ao verificar admin:', e);
        }
        
        console.log('[AUTO-EVENTO] Abrindo evento para etapa:', etapaId);
        
        // Aguardar um pouco para garantir que tudo está carregado
        setTimeout(() => {
          // Tentar chamar a função mostrarEventoAoVivo
          if (typeof mostrarEventoAoVivo === 'function') {
            console.log('[AUTO-EVENTO] Função disponível, abrindo modal...');
            mostrarEventoAoVivo(etapaId);
          } else {
            console.warn('[AUTO-EVENTO] Função mostrarEventoAoVivo ainda não está disponível');
          }
        }, 500);
        
        // Limpar URL para não reabrir o modal ao atualizar
        window.history.replaceState({}, document.title, '/admin');
      }
    });
  </script>
</body>
</html>