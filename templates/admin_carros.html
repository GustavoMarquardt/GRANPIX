{% extends "admin_base.html" %}
{% block title %}GRANPIX - Cadastrar Carros{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Total de Equipes</div>
        <div class="stat-value" id="totalEquipes">-</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Solicitações de Peça</div>
        <div class="stat-value" id="solicitacoesPecasPendentes">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Solicitações de Carro</div>
        <div class="stat-value" id="solicitacoesCarrosPendentes">0</div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">Novo Carro</h5>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>Modelo</label>
            <input type="text" class="form-control" id="carroModelo" placeholder="Ex: Ferrari F40">
          </div>
          <div class="form-group">
            <label>Marca</label>
            <input type="text" class="form-control" id="carroMarca" placeholder="Ex: Ferrari">
          </div>
          <div class="form-group">
            <label>Preço</label>
            <input type="number" class="form-control" id="carroPreco" placeholder="Ex: 50000" step="0.01">
          </div>
          <div class="form-group">
            <label>Imagem (opcional)</label>
            <input type="file" class="form-control" id="carroImagem" accept="image/*">
            <small class="text-muted d-block mt-2">Selecione uma imagem para o carro (PNG, JPG, etc)</small>
            <div id="carroImagemPreview" style="margin-top: 10px;">
              <img id="carroImagemPreviewImg" style="max-width: 100%; max-height: 150px; display: none;">
            </div>
          </div>
          <button class="btn btn-primary w-100" type="button" onclick="window.cadastrarCarro()">Cadastrar Carro</button>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">Carros Cadastrados</h5>
        </div>
        <div class="card-body" id="listaCarros" style="max-height: 500px; overflow-y: auto;">
          <p class="text-muted">Carregando...</p>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="modalEditarCarro" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">Editar Carro</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editCarroId">
        <div class="form-group">
          <label>Marca</label>
          <input type="text" class="form-control" id="editCarroMarca">
        </div>
        <div class="form-group">
          <label>Modelo</label>
          <input type="text" class="form-control" id="editCarroModelo">
        </div>
        <div class="form-group">
          <label>Preço</label>
          <input type="number" class="form-control" id="editCarroPreco" step="0.01">
        </div>
        <div class="form-group">
          <label>Imagem</label>
          <div id="editCarroImagemAtual" style="margin-bottom: 10px;">
            <img id="editCarroImagemAtualImg" style="max-width: 100%; max-height: 150px; display: none;" alt="Imagem atual">
          </div>
          <input type="file" class="form-control" id="editCarroImagem" accept="image/*">
          <small class="text-muted d-block mt-2">Selecione uma nova imagem para substituir (opcional)</small>
          <button type="button" class="btn btn-sm btn-danger mt-2" id="editCarroDeletarImagemBtn" style="display: none;">Deletar Imagem</button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" onclick="window.deletarCarro()">Deletar Carro</button>
        <button type="button" class="btn btn-success" onclick="window.salvarEdicaoCarro()">Salvar</button>
      </div>
    </div>
  </div>
</div>
<div class="toast-container"></div>
{% endblock %}
{% block extra_scripts %}
<script>
(function() {
  let intervaloSolicitacoesPecas = null, intervaloSolicitacoesCarros = null, intervaloContadores = null;
  let abaSolicitacoesPecasAtiva = true, abaSolicitacoesCarrosAtiva = false;
  function lerArquivoComoBase64(arquivo) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(arquivo);
    });
  }
  function temModalAbertoAdmin() { return document.querySelectorAll('.modal.show').length > 0; }
  function iniciarAutoRefreshAdmin() {
    intervaloSolicitacoesPecas = setInterval(() => { if (abaSolicitacoesPecasAtiva && !document.hidden && !temModalAbertoAdmin()) carregarSolicitacoes && carregarSolicitacoes(); }, 3000);
    intervaloSolicitacoesCarros = setInterval(() => { if (abaSolicitacoesCarrosAtiva && !document.hidden && !temModalAbertoAdmin()) carregarSolicitacoesCarros && carregarSolicitacoesCarros(); }, 3000);
    intervaloContadores = setInterval(() => { if (!document.hidden && !temModalAbertoAdmin()) atualizarContadoresSolicitacoes && atualizarContadoresSolicitacoes().catch(()=>{}); }, 3000);
  }
  window.addEventListener('load', () => {
    atualizarStatusAdmin && atualizarStatusAdmin();
    atualizarContadoresSolicitacoes && atualizarContadoresSolicitacoes().catch(e => console.error(e));
    carregarCarros();
    iniciarAutoRefreshAdmin();
  });
  async function atualizarStatusAdmin() {
    try { const resp = await fetch('/api/admin/status'); const status = await resp.json(); document.getElementById('totalEquipes').textContent = status.total_equipes || 0; } catch (e) {}
  }
  async function atualizarContadoresSolicitacoes() {
    if (typeof window.atualizarContadoresSolicitacoesAdmin === 'function') return window.atualizarContadoresSolicitacoesAdmin();
    try {
      const respPecas = await fetch('/api/admin/solicitacoes-pecas');
      const pecas = await respPecas.json();
      const pecasPendentes = Array.isArray(pecas) ? pecas.filter(s => s.status === 'pendente').length : 0;
      const elemPecas = document.getElementById('solicitacoesPecasPendentes');
      if (elemPecas) elemPecas.textContent = pecasPendentes;
      const respCarros = await fetch('/api/admin/solicitacoes-carros');
      const carros = await respCarros.json();
      const carrosPendentes = Array.isArray(carros) ? carros.filter(s => s.status === 'pendente').length : 0;
      const elemCarros = document.getElementById('solicitacoesCarrosPendentes');
      if (elemCarros) elemCarros.textContent = carrosPendentes;
    } catch (e) {}
  }
  async function carregarCarros() {
    try {
      const resp = await fetch('/api/admin/carros');
      const data = await resp.json();
      const lista = document.getElementById('listaCarros');
      lista.innerHTML = '';
      if (data.erro || !Array.isArray(data) || data.length === 0) {
        lista.innerHTML = '<p class="text-muted">Nenhum carro cadastrado</p>';
        return;
      }
      data.forEach((carro, idx) => {
        const div = document.createElement('div');
        div.className = 'mb-3 p-2 border rounded bg-light d-flex justify-content-between align-items-start gap-3';
        if (carro.imagem) {
          const imgCol = document.createElement('div');
          imgCol.style.flexShrink = '0';
          imgCol.innerHTML = '<img src="' + carro.imagem + '" style="width: 80px; height: 60px; object-fit: cover; border-radius: 4px;" alt="' + (carro.marca + ' ' + carro.modelo) + '">';
          div.appendChild(imgCol);
        }
        const carroInfo = document.createElement('div');
        carroInfo.style.flex = '1';
        carroInfo.innerHTML = '<strong>[' + (idx + 1) + '] ' + carro.marca + ' ' + carro.modelo + '</strong><small class="d-block text-success fw-bold">' + (typeof formatarMoeda === 'function' ? formatarMoeda(carro.preco) : carro.preco) + '</small>';
        const botao = document.createElement('button');
        botao.className = 'btn btn-sm btn-warning ms-2';
        botao.textContent = ' Editar';
        botao.onclick = () => abrirEdicaoCarro(carro);
        div.appendChild(carroInfo);
        div.appendChild(botao);
        lista.appendChild(div);
      });
    } catch (e) { document.getElementById('listaCarros').innerHTML = '<p class="text-danger">Erro ao carregar: ' + e.message + '</p>'; }
  }
  window.cadastrarCarro = async function() {
    var marca = (document.getElementById('carroMarca') && document.getElementById('carroMarca').value) ? document.getElementById('carroMarca').value.trim() : '';
    var modelo = (document.getElementById('carroModelo') && document.getElementById('carroModelo').value) ? document.getElementById('carroModelo').value.trim() : '';
    var preco = (document.getElementById('carroPreco') && document.getElementById('carroPreco').value) ? document.getElementById('carroPreco').value.trim() : '';
    var inputImagem = document.getElementById('carroImagem');
    if (!modelo || !marca) { alert('Preencha Marca e Modelo.'); return; }
    if (!preco || isNaN(parseFloat(preco))) { alert('Preencha um Preço válido.'); return; }
    var payload = { marca: marca, modelo: modelo, preco: preco, classe: 'basico', descricao: marca + ' ' + modelo };
    if (inputImagem && inputImagem.files && inputImagem.files.length) { try { payload.imagem = (await lerArquivoComoBase64(inputImagem.files[0])).split(',')[1] || ''; } catch (e) {} }
    try {
      var r = await fetch('/api/admin/cadastrar-carro', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      var data = await r.json();
      if (data.sucesso) {
        document.getElementById('carroMarca').value = ''; document.getElementById('carroModelo').value = ''; document.getElementById('carroPreco').value = '';
        if (inputImagem) inputImagem.value = '';
        carregarCarros();
        alert('Carro cadastrado com sucesso.');
      } else { alert('Erro: ' + (data.erro || 'Erro ao cadastrar')); }
    } catch (e) { alert('Erro ao cadastrar: ' + e.message); }
  };
  function fecharModalEditarCarro() {
    const modalEl = document.getElementById('modalEditarCarro');
    if (!modalEl) return;
    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) bootstrap.Modal.getInstance(modalEl)?.hide();
    else { modalEl.classList.remove('show'); modalEl.style.display = 'none'; document.querySelectorAll('.modal-backdrop').forEach(b => b.remove()); document.body.classList.remove('modal-open'); }
  }
  function abrirEdicaoCarro(carro) {
    document.getElementById('editCarroId').value = carro.id || '';
    document.getElementById('editCarroMarca').value = carro.marca || '';
    document.getElementById('editCarroModelo').value = carro.modelo || '';
    document.getElementById('editCarroPreco').value = carro.preco ?? '';
    const imgEl = document.getElementById('editCarroImagemAtualImg');
    if (imgEl) {
      if (carro.imagem) { imgEl.src = carro.imagem.startsWith('data:') ? carro.imagem : 'data:image/jpeg;base64,' + carro.imagem; imgEl.style.display = 'block'; }
      else { imgEl.src = ''; imgEl.style.display = 'none'; }
      const btnDel = document.getElementById('editCarroDeletarImagemBtn');
      if (btnDel) btnDel.style.display = carro.imagem ? 'inline-block' : 'none';
    }
    document.getElementById('editCarroImagem').value = '';
    const modalEl = document.getElementById('modalEditarCarro');
    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) new bootstrap.Modal(modalEl).show();
    else { modalEl.classList.add('show'); modalEl.style.display = 'block'; document.body.classList.add('modal-open'); const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop fade show'; document.body.appendChild(backdrop); }
  }
  async function salvarEdicaoCarro() {
    const id = document.getElementById('editCarroId')?.value;
    const marca = document.getElementById('editCarroMarca')?.value?.trim() || '';
    const modelo = document.getElementById('editCarroModelo')?.value?.trim() || '';
    const preco = document.getElementById('editCarroPreco')?.value?.trim() || '';
    if (!id) { alert('ID do carro não encontrado.'); return; }
    if (!marca || !modelo) { alert('Preencha Marca e Modelo.'); return; }
    if (!preco || isNaN(parseFloat(preco))) { alert('Preço inválido.'); return; }
    const payload = { id, marca, modelo, preco };
    const inputNovaImagem = document.getElementById('editCarroImagem');
    if (inputNovaImagem?.files?.length) { try { payload.imagem = (await lerArquivoComoBase64(inputNovaImagem.files[0])).split(',')[1] || ''; } catch (e) {} }
    try {
      const r = await fetch('/api/admin/editar-carro', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const data = await r.json();
      if (data.sucesso) { fecharModalEditarCarro(); carregarCarros(); alert('Carro atualizado.'); } else { alert('Erro: ' + (data.erro || 'Erro ao salvar')); }
    } catch (e) { alert('Erro ao salvar: ' + e.message); }
  }
  async function deletarCarro() {
    const id = document.getElementById('editCarroId')?.value;
    if (!id) return;
    if (!confirm('Tem certeza que deseja deletar este carro?')) return;
    try {
      const r = await fetch('/api/admin/deletar-carro', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) });
      const data = await r.json();
      if (data.sucesso) { fecharModalEditarCarro(); carregarCarros(); alert('Carro deletado.'); } else { alert('Erro: ' + (data.erro || '')); }
    } catch (e) { alert('Erro ao deletar: ' + e.message); }
  }
  window.abrirEdicaoCarro = abrirEdicaoCarro;
  window.salvarEdicaoCarro = salvarEdicaoCarro;
  window.deletarCarro = deletarCarro;
})();
</script>
{% endblock %}
