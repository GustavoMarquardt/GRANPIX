{% extends "admin_base.html" %}
{% block title %}GRANPIX - ColocaÃ§Ãµes e HistÃ³rico de Campeonatos{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="card bg-dark text-white">
    <div class="card-header">
      <h5 class="mb-0">ColocaÃ§Ãµes por Campeonato</h5>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Selecione o campeonato</label>
        <select class="form-select form-select-lg bg-secondary text-white" id="selectCampeonato">
          <option value="">-- Carregando --</option>
        </select>
        <small class="text-muted d-block mt-1">Campeonatos recentes primeiro. Selecione para ver as colocaÃ§Ãµes (equipes/pilotos) e pontos.</small>
      </div>
      <div id="painelColocacoes" class="mt-3" style="display:none;">
        <h6 class="text-warning mb-2" id="tituloCampeonato">â€”</h6>
        <p class="small text-muted mb-2">Pontos por etapa: 1Âº=100, 2Âº=88, 3Âº=76, 4Âº=64, 5Âº-8Âº=48, 9Âº-16Âº=32, 17Âº-32Âº=16</p>
        <div class="table-responsive">
          <table class="table table-dark table-striped tabela-colocacoes">
            <thead><tr><th>Pos.</th><th>Equipe</th><th>Piloto</th><th>Pontos</th></tr></thead>
            <tbody id="tbodyColocacoes"></tbody>
          </table>
        </div>
      </div>
      <div id="msgVazio" class="text-muted text-center py-4" style="display:none;">
        Nenhuma colocaÃ§Ã£o registrada para este campeonato.
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_head %}
<style>
.tabela-colocacoes th { background: #1a1a1a; color: #ffc107; }
</style>
{% endblock %}
{% block extra_scripts %}
<script>
(async function() {
  const sel = document.getElementById('selectCampeonato');
  const painel = document.getElementById('painelColocacoes');
  const tbody = document.getElementById('tbodyColocacoes');
  const titulo = document.getElementById('tituloCampeonato');
  const msgVazio = document.getElementById('msgVazio');

  const r = await fetch('/api/admin/listar-campeonatos', { credentials: 'include' });
  const data = await r.json();
  const campeonatos = (data && data.campeonatos) ? data.campeonatos : (Array.isArray(data) ? data : []);
  sel.innerHTML = '<option value="">-- Selecione um campeonato --</option>';
  campeonatos.forEach(c => {
    const status = c.em_andamento ? ' (Em andamento)' : ' (ConcluÃ­do)';
    const nome = (c.nome || c.id || 'Sem nome') + (c.serie ? ' - SÃ©rie ' + c.serie : '') + status;
    sel.appendChild(new Option(nome, c.id));
  });

  sel.addEventListener('change', async function() {
    const id = this.value;
    if (!id) { painel.style.display = 'none'; msgVazio.style.display = 'none'; return; }
    const camp = campeonatos.find(x => x.id === id);
    titulo.textContent = (camp && camp.nome) ? camp.nome : id;
    const pr = await fetch('/api/admin/pontuacoes-campeonato/' + id, { credentials: 'include' });
    const pd = await pr.json();
    const pontuacoes = pd.pontuacoes || [];
    if (pontuacoes.length === 0) { painel.style.display = 'none'; msgVazio.style.display = 'block'; return; }
    painel.style.display = 'block';
    msgVazio.style.display = 'none';
    tbody.innerHTML = '';
    pontuacoes.forEach(p => {
      const pos = p.colocacao != null ? p.colocacao + 'Âº' : '-';
      const medal = p.colocacao === 1 ? 'ðŸ¥‡' : p.colocacao === 2 ? 'ðŸ¥ˆ' : p.colocacao === 3 ? 'ðŸ¥‰' : '';
      const tr = document.createElement('tr');
      tr.innerHTML = '<td>' + medal + ' ' + pos + '</td><td>' + (p.equipe_nome || '-') + '</td><td>' + (p.piloto_nome || '-') + '</td><td>' + (p.pontos || 0) + '</td>';
      tbody.appendChild(tr);
    });
  });
})();
</script>
{% endblock %}
