<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRANPIX - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">üèéÔ∏è GRANPIX - Minha Equipe</span>
            <div>
                <span id="nomeEquipe" class="badge bg-primary me-2" style="font-size: 14px;">Equipe</span>
                <a href="/logout" class="btn btn-sm btn-outline-danger">Sair</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar com Detalhes -->
            <div class="col-md-3">
                <div id="equipeDetalhes"></div>
            </div>

            <!-- Conte√∫do Principal -->
            <div class="col-md-9">
                <!-- Abas -->
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#carros-tab">Loja de Carros</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#pecas-tab">Loja de Pe√ßas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#garagem-tab">Garagem</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#etapas-tab">üèÅ Etapas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#pilotos-tab">üèéÔ∏è Pilotos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#historico-tab">Hist√≥rico</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#transferencias-tab">üí∞ Transfer√™ncias</a>
                    </li>
                </ul>

                <!-- Conte√∫do das Abas -->
                <div class="tab-content mt-4">
                    <!-- Carros -->
                    <div id="carros-tab" class="tab-pane fade">
                        <h4>Loja de Carros</h4>
                        <div class="row" id="carrosGrid"></div>
                    </div>

                    <!-- Pe√ßas -->
                    <div id="pecas-tab" class="tab-pane fade">
                        <h4>Loja de Pe√ßas</h4>
                        <div class="mb-3">
                            <label for="filtroTipoPeca" class="form-label">Filtrar por Tipo:</label>
                            <select id="filtroTipoPeca" class="form-select" onchange="renderizarPecas()">
                                <option value="">Todos os tipos</option>
                                <option value="motor">‚öôÔ∏è Motor</option>
                                <option value="cambio">‚õìÔ∏è C√¢mbio</option>
                                <option value="kit_angulo">üìê Kit √Çngulo</option>
                                <option value="suspensao">üîß Suspens√£o</option>
                                <option value="diferencial">üîÄ Diferencial</option>
                            </select>
                        </div>
                        <div class="row" id="pecasGrid"></div>
                    </div>

                    <!-- Garagem -->
                    <div id="garagem-tab" class="tab-pane fade show active">
                        <h4>üèéÔ∏è Garagem</h4>
                        
                        <!-- Card Pr√≥xima Etapa -->
                        <div class="card bg-light mb-4" id="proximaEtapaCard" style="display: none;">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">üèÅ Pr√≥xima Etapa</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <p class="mb-1"><strong id="proximaEtapaNome">-</strong></p>
                                        <p class="mb-2 text-muted" id="proximaEtapaData">-</p>
                                        <p class="mb-0" id="proximaEtapaDescricao">-</p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <button class="btn btn-primary btn-sm" id="btnInscreverEtapa" onclick="inscreverEtapa()" style="display: none;">
                                            Inscrever-se
                                        </button>
                                        <small class="text-muted d-block mt-2">S√©rie <strong id="proximaEtapaSerie">-</strong></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="garagemContent"></div>
                    </div>

                    <!-- Etapas -->
                    <div id="etapas-tab" class="tab-pane fade">
                        <h4>üèÅ Etapas do Campeonato</h4>
                        <div class="row" id="etapasContent"></div>
                    </div>

                    <!-- Pilotos -->
                    <div id="pilotos-tab" class="tab-pane fade">
                        <h4>üèéÔ∏è Gerenciar Pilotos</h4>
                        <div class="row">
                            <!-- Card de Convites (para dono) -->
                            <div class="col-md-6 mb-4">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0">üéüÔ∏è C√≥digo de Convite para Piloto</h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted small">Gere um c√≥digo para convidar pilotos a sua equipe</p>
                                        <button type="button" class="btn btn-success w-100 mb-3" onclick="gerarCodigoConvite()">
                                            Gerar Novo C√≥digo
                                        </button>
                                        <div id="codigoGerado" class="alert alert-info" style="display:none;">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <small class="text-muted">C√≥digo Gerado:</small>
                                                    <h6 class="mb-0" id="codigoMostrado">-</h6>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-primary" onclick="copiarCodigo()">
                                                    üìã Copiar
                                                </button>
                                            </div>
                                        </div>
                                        <div id="listaPilotos">
                                            <h6 class="mt-4">Pilotos da Equipe:</h6>
                                            <div id="pilotosLista" class="list-group"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Card de Vincula√ß√£o (para piloto) -->
                            <div class="col-md-6 mb-4" {% if user_type == 'equipe' %}style="display:none;"{% endif %}>
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0">ü§ù Vincular-se a uma Equipe</h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted small">Digite o c√≥digo de convite para se vincular a uma equipe</p>
                                        <div class="mb-3">
                                            <label for="inputCodigoConvite" class="form-label">C√≥digo de Convite:</label>
                                            <input type="text" id="inputCodigoConvite" class="form-control form-control-lg" placeholder="Ex: ABC12345" maxlength="8">
                                        </div>
                                        <button type="button" class="btn btn-info w-100 mb-3" onclick="vincularAEquipe()">
                                            Vincular-se
                                        </button>
                                        <div id="minhasEquipes">
                                            <h6 class="mt-4">Minhas Equipes:</h6>
                                            <div id="equipesList" class="list-group"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hist√≥rico -->
                    <div id="historico-tab" class="tab-pane fade">
                        <h4>Hist√≥rico de Compras</h4>
                        <div id="historicoList"></div>
                    </div>

                    <!-- Transfer√™ncias -->
                    <div id="transferencias-tab" class="tab-pane fade">
                        <h4>üí∞ Transfer√™ncias de Dinheiro</h4>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">üì§ Enviar Dinheiro</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="equipeDestino" class="form-label">Equipe Destino:</label>
                                            <select id="equipeDestino" class="form-select">
                                                <option value="">Selecione uma equipe...</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="valorTransferencia" class="form-label">Valor (üí∞):</label>
                                            <input type="number" id="valorTransferencia" class="form-control" min="1" placeholder="Ex: 1000">
                                        </div>
                                        <div class="alert alert-info mb-3">
                                            <small>Taxa configur√°vel em <strong>Configura√ß√µes</strong> (padr√£o 10%)</small>
                                        </div>
                                        <div class="alert alert-info mb-3" id="previewTransferencia" style="display:none;">
                                            <small>
                                                Valor a enviar: <strong id="previewEnvio">0</strong> üí∞<br>
                                                <span id="previewTaxaLabel">Taxa (10%):</span> <strong id="previewTaxa">0</strong> üí∞<br>
                                                Equipe receber√°: <strong id="previewRecebe" class="text-success">0</strong> üí∞
                                            </small>
                                        </div>
                                        <button class="btn btn-primary w-100" onclick="executarTransferencia()">
                                            ‚úì Transferir
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0">üìã Hist√≥rico de Transa√ß√µes</h5>
                                    </div>
                                    <div class="card-body" id="historicoTransferencias" style="max-height: 400px; overflow-y: auto;">
                                        <p class="text-muted">Carregando...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div class="modal fade" id="confirmacaoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Confirmar Compra</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 id="modalNome"></h6>
                    <p class="text-muted" id="modalDescricao"></p>
                    
                    <div class="row mt-4">
                        <div class="col-6">
                            <small class="text-muted">Pre√ßo</small>
                            <div class="h5" id="modalPreco"></div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Novo Saldo</small>
                            <div class="h5 text-success" id="modalNovoSaldo"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarCompra()">Confirmar Compra</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Escolher Carro (para pe√ßas) -->
    <div class="modal fade" id="escolherCarroModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Escolher Carro</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Selecione o carro onde deseja instalar a pe√ßa:</p>
                    <div id="listaCarrosModal"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal QR Code PIX (compacto - bot√£o de pagamento sempre vis√≠vel) -->
    <div class="modal fade" id="pixModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm" style="max-width: 380px;">
            <div class="modal-content">
                <div class="modal-header bg-success text-white py-2">
                    <h5 class="modal-title mb-0">üí∞ Pagamento PIX</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-2" style="max-height: 70vh; overflow-y: auto;">
                    <p class="text-muted mb-2 small">Escaneie o QR Code para pagar</p>
                    
                    <div id="pixQrCodeContainer" class="mb-2 text-center" style="padding: 10px; display: flex; justify-content: center; align-items: center; min-height: 180px;">
                        <img id="pixQrCode" src="" alt="QR Code PIX" style="display: block; margin: 0 auto; max-width: 100%; max-height: 200px; width: auto; height: auto; object-fit: contain; image-rendering: pixelated;">
                    </div>
                    
                    <div class="card bg-light mb-2 py-2 px-2">
                        <p class="mb-1 small"><strong>Item:</strong> <span id="pixItemNome">-</span></p>
                        <div class="d-flex justify-content-between small">
                            <span>Item:</span><strong>R$ <span id="pixValorItem">0.00</span></strong>
                        </div>
                        <div class="d-flex justify-content-between small text-danger">
                            <span>Taxa:</span><strong>+ R$ <span id="pixTaxaValor">0.00</span></strong>
                        </div>
                        <div class="d-flex justify-content-between border-top pt-1">
                            <span class="fw-bold">Total:</span>
                            <span class="text-success fw-bold">R$ <span id="pixValorTotal">0.00</span></span>
                        </div>
                    </div>
                    
                    <div id="pixStatus" class="alert alert-info py-2 mb-2 small">‚è≥ Aguardando confirma√ß√£o...</div>
                    
                    <div class="d-grid gap-2 mb-0">
                        <button type="button" class="btn btn-success btn-lg" id="botaoConfirmarManual" onclick="confirmarPagamentoManual()">‚úì Confirmar Pagamento</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="botaoFecharPix" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Compra Finalizada -->
    <div class="modal fade" id="compraFinalizadaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">‚úÖ Compra Finalizada!</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-4">
                        <div style="font-size: 48px; color: #28a745;">‚úì</div>
                    </div>
                    
                    <h5 class="mb-4">Sua compra foi realizada com sucesso!</h5>
                    
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <small class="text-muted">Saldo Anterior</small>
                                    <div class="h6 mb-0" id="saldoAnterior">-</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Valor Gasto</small>
                                    <div class="h6 mb-0 text-danger" id="valorGasto">-</div>
                                </div>
                            </div>
                            <div class="border-top pt-3">
                                <small class="text-muted">Novo Saldo</small>
                                <div class="h4 text-success mb-0" id="novoSaldo">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <p class="text-muted small mb-0">Suas pe√ßas foram movidas para o armaz√©m e est√£o prontas para instala√ß√£o!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">Continuar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Apelido do Carro -->
    <div class="modal fade" id="editarApelidoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Editar Apelido do Carro</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Digite um apelido para seu carro:</p>
                    <input type="text" class="form-control form-control-lg" id="inputApelido" placeholder="Ex: Meu Raio, Destruidor, etc..." maxlength="50">
                    <small class="text-muted d-block mt-2">Deixe vazio para remover o apelido</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarEditarApelido()">Salvar Apelido</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Remover Pe√ßa -->
    <div class="modal fade" id="removerPecaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">‚ö†Ô∏è Remover Pe√ßa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong id="nomePecaRemover">Pe√ßa</strong></p>
                    <div class="mb-3">
                        <label class="form-label"><strong>Para onde deseja mover a pe√ßa?</strong></label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="destino" id="destinoArmazem" value="armazem" checked>
                            <label class="btn btn-outline-primary" for="destinoArmazem">üè† Armaz√©m</label>
                            <input type="radio" class="btn-check" name="destino" id="destinoCarro" value="carro">
                            <label class="btn btn-outline-primary" for="destinoCarro">üöó Outro Carro</label>
                        </div>
                    </div>
                    <div id="selectorCarroDest" class="mb-3" style="display: none;">
                        <label class="form-label">Selecione o carro de destino:</label>
                        <select id="carroDestSelect" class="form-select">
                            <option value="">-- Carregando carros --</option>
                        </select>
                        <small class="text-muted d-block mt-2">‚ö†Ô∏è O carro de destino n√£o pode ter uma pe√ßa do mesmo tipo instalada</small>
                    </div>
                    <div id="alertaCustoOutroCarro" class="alert alert-info" style="display: none;">
                        <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Para instalar essa pe√ßa em outro carro, voc√™ precisar√° gerar um PIX de:
                        <div class="mt-2">
                            <h5 class="text-primary" id="valorInstalacao">-</h5>
                        </div>
                    </div>
                    <p class="text-muted">Tem certeza que deseja remover essa pe√ßa?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarRemoverPeca()">Retirar Pe√ßa</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Modal de Escolha de Destino por Pe√ßa -->
    <div class="modal fade" id="modalDestino" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Escolha o destino de cada pe√ßa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="listaPecasDestino" style="max-height: 400px; overflow-y: auto;">
                        <!-- Pe√ßas ser√£o inseridas aqui via JS -->
                    </div>
                    
                    <div class="mt-4 pt-3 border-top">
                        <div class="row">
                            <div class="col-6">
                                <p class="text-muted mb-1">Para Armaz√©m:</p>
                                <p class="h5"><strong id="totalArmazem">R$ 0,00</strong></p>
                                <small class="text-muted" id="qtdArmazem">0 pe√ßas</small>
                            </div>
                            <div class="col-6 text-end">
                                <p class="text-muted mb-1">Para Carro Ativo:</p>
                                <p class="h5"><strong id="totalCarroAtivo">R$ 0,00</strong></p>
                                <small class="text-muted" id="qtdCarroAtivo">0 pe√ßas</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarDistribuicaoPecas()">
                        Continuar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Painel Flutuante do Carrinho -->
    <div id="carrinhoPanel" class="carrinho-panel" style="display: none;">
        <div class="carrinho-panel-header">
            <span>üõí Carrinho</span>
            <button class="btn btn-sm btn-close" onclick="toggleCarrinhoPanel()"></button>
        </div>
        <div id="carrinhoPanelContent" class="carrinho-panel-content">
            <p class="text-muted text-center">Carrinho vazio</p>
        </div>
        <div class="carrinho-panel-footer">
            <button class="btn btn-primary btn-sm w-100" id="btnComprar" onclick="abrirModalDestino()" style="display: none;">
                üõí Comprar
            </button>
        </div>
    </div>

    <!-- Bot√£o Flutuante do Carrinho -->
    <button id="carrinhoFlutuante" class="carrinho-flutuante" onclick="toggleCarrinhoPanel()" style="display: none;">
        üõí <span id="carrinhoQtd" class="carrinho-badge">0</span>
    </button>

    <style>
        .carrinho-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 350px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1050;
            display: flex;
            flex-direction: column;
        }

        .carrinho-panel-header {
            background: #0d6efd;
            color: white;
            padding: 12px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .carrinho-panel-content {
            flex-grow: 1;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
            border-bottom: 1px solid #eee;
        }

        .carrinho-panel-footer {
            padding: 12px;
            background: #f9f9f9;
            border-radius: 0 0 8px 8px;
        }

        .carrinho-flutuante {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #0d6efd;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1040;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .carrinho-flutuante:hover {
            background: #0a58ca;
            transform: scale(1.1);
        }

        .carrinho-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .carrinho-item {
            padding: 8px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .form-label-sm {
            font-size: 12px;
            margin-bottom: 4px;
        }

        .form-select-sm {
            font-size: 13px;
            padding: 4px 8px;
        }

        .destinacao-options {
            display: flex;
            gap: 12px;
            flex-direction: column;
        }

        .destinacao-btn {
            padding: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .destinacao-btn:hover {
            border-color: #0d6efd;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2);
        }

        .destinacao-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .destinacao-title {
            font-weight: bold;
            margin-bottom: 4px;
            color: #333;
        }

        .destinacao-desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .destinacao-preco {
            font-size: 11px;
            color: #888;
        }

        .peca-destino-item {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }

        .peca-destino-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .peca-destino-nome {
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }

        .peca-destino-preco {
            font-size: 12px;
            color: #666;
        }

        .peca-destino-buttons {
            display: flex;
            gap: 8px;
        }

        .peca-destino-btn {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            text-align: center;
        }

        .peca-destino-btn:hover {
            border-color: #0d6efd;
            background: #f0f7ff;
        }

        .peca-destino-btn.active {
            border-color: #0d6efd;
            background: #0d6efd;
            color: white;
        }

        .peca-destino-btn.armazem.active {
            background: #198754;
            border-color: #198754;
        }

        .peca-destino-btn.carro.active {
            background: #0d6efd;
            border-color: #0d6efd;
        }
    </style>

    <script>
        function toggleCarrinhoPanel() {
            const panel = document.getElementById('carrinhoPanel');
            panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
        }

        // Atualizar painel quando carrinho muda
        function atualizarPainelCarrinho() {
            const btn = document.getElementById('carrinhoFlutuante');
            const qtdSpan = document.getElementById('carrinhoQtd');
            const panelContent = document.getElementById('carrinhoPanelContent');

            if (carrinho.length === 0) {
                btn.style.display = 'none';
                panelContent.innerHTML = '<p class="text-muted text-center">Carrinho vazio</p>';
                return;
            }

            btn.style.display = 'flex';
            qtdSpan.textContent = carrinho.length;

            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            let total = 0;
            
            carrinho.forEach(peca => {
                const subtotal = peca.preco * (peca.quantidade || 1);
                total += subtotal;
                html += `
                    <div class="carrinho-item">
                        <div style="flex-grow: 1;">
                            <strong style="font-size: 13px;">${peca.nome}</strong><br>
                            <small>${formatarMoeda(peca.preco)} x ${peca.quantidade || 1}</small>
                        </div>
                        <button class="btn btn-sm btn-danger" style="padding: 2px 6px;" onclick="removerDoCarrinho('${peca.id}'); atualizarPainelCarrinho();">‚úï</button>
                    </div>
                `;
            });

            html += '</div>';
            html += `<div class="mt-2" style="text-align: right; font-weight: bold; padding-top: 8px; border-top: 1px solid #eee;">
                Total: ${formatarMoeda(total)}
            </div>`;

            panelContent.innerHTML = html;
        }
    </script>

    
    <script>
        // Limpar e cancelar transa√ß√£o quando modal fecha
        const pixModalEl = document.getElementById('pixModal');
        pixModalEl.addEventListener('hidden.bs.modal', () => {
            // Limpar a imagem do QRCode
            document.getElementById('pixQrCode').src = '';
            document.getElementById('pixQrCodeContainer').style.display = 'none';
            
            // Se existir uma transa√ß√£o ativa, cancel√°-la (fire-and-forget)
            if (window.transacaoPixAtual) {
                const transacaoId = window.transacaoPixAtual;
                console.log(`[PIX MODAL CLOSE] Cancelando transa√ß√£o: ${transacaoId}`);
                
                // Parar polling (pixPollings √© global em script.js)
                if (typeof pixPollings !== 'undefined' && pixPollings[transacaoId]) {
                    clearInterval(pixPollings[transacaoId]);
                    delete pixPollings[transacaoId];
                    console.log(`[PIX MODAL CLOSE] Polling parado`);
                }
                
                // Chamar API para cancelar transa√ß√£o no banco (n√£o aguarda resposta)
                fetch('/api/cancelar-transacao-pix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transacao_id: transacaoId })
                }).then(resp => resp.json()).then(resultado => {
                    if (resultado.sucesso) {
                        console.log(`[PIX MODAL CLOSE] Transa√ß√£o ${transacaoId} cancelada com sucesso`);
                    } else if (resultado.status === 400) {
                        // Transa√ß√£o n√£o est√° pendente (pode ter sido aprovada) - √© ok
                        console.log(`[PIX MODAL CLOSE] Transa√ß√£o ${transacaoId} j√° n√£o est√° pendente`);
                    }
                }).catch(e => {
                    console.error(`[PIX MODAL CLOSE] Erro ao cancelar:`, e);
                });
                
                // Limpar vari√°vel
                window.transacaoPixAtual = null;
                window.compraPendentePix = null;
            }
        });

        // Inicializar dashboard - DEPOIS que script.js foi carregado
        window.addEventListener('load', () => {
            document.getElementById('nomeEquipe').textContent = 
                `üìä ${localStorage.getItem('equipe_nome') || 'Equipe'}`;
            
            // Aguardar para garantir que script.js foi processado
            setTimeout(() => {
                if (typeof carregarDetalhesEquipe === 'function') {
                    carregarDetalhesEquipe();
                } else {
                    console.warn('Aviso: carregarDetalhesEquipe ainda n√£o est√° dispon√≠vel');
                }
            }, 500);
        });

        // Aba Carros - verificar se fun√ß√£o existe antes de usar
        const abaCarro = document.querySelector('a[href="#carros-tab"]');
        if (abaCarro) {
            abaCarro.addEventListener('click', () => {
                if (typeof carregarCarros === 'function') carregarCarros();
            });
        }
        
        // Aba Pe√ßas
        const abaPecas = document.querySelector('a[href="#pecas-tab"]');
        if (abaPecas) {
            abaPecas.addEventListener('click', () => {
                if (typeof carregarPecas === 'function') carregarPecas();
            });
        }
        
        // Aba Garagem
        const abaGaragem = document.querySelector('a[href="#garagem-tab"]');
        if (abaGaragem) {
            abaGaragem.addEventListener('click', () => {
                if (typeof carregarGaragem === 'function') carregarGaragem();
            });
        }
        
        // Aba Hist√≥rico
        const abaHistorico = document.querySelector('a[href="#historico-tab"]');
        if (abaHistorico) {
            abaHistorico.addEventListener('click', () => {
                if (typeof carregarHistorico === 'function') carregarHistorico();
            });
        }
        
        // Aba Transfer√™ncias
        const abaTransferencias = document.querySelector('a[href="#transferencias-tab"]');
        if (abaTransferencias) {
            abaTransferencias.addEventListener('click', () => {
                if (typeof carregarEquipesParaTransferencia === 'function') carregarEquipesParaTransferencia();
                if (typeof carregarHistoricoTransferencias === 'function') carregarHistoricoTransferencias();
            });
        }

        // Aba Etapas
        const abaEtapas = document.querySelector('a[href="#etapas-tab"]');
        if (abaEtapas) {
            abaEtapas.addEventListener('click', () => {
                carregarEtapasEquipe();
            });
        }

        // Aba Pilotos
        const abaPilotos = document.querySelector('a[href="#pilotos-tab"]');
        if (abaPilotos) {
            abaPilotos.addEventListener('click', () => {
                carregarPilotos();
            });
        }

        // Atualizar preview de transfer√™ncia
        const inputValor = document.getElementById('valorTransferencia');
        if (inputValor) {
            inputValor.addEventListener('input', () => {
                if (typeof atualizarPreviewTransferencia === 'function') atualizarPreviewTransferencia();
            });
        }

        // ========== FUN√á√ïES PILOTOS ==========
        async function carregarPilotos() {
            const equipeId = localStorage.getItem('equipe_id');
            if (!equipeId) return;

            try {
                // Carregar pilotos da equipe
                const response = await fetch(`/api/equipes/${equipeId}/pilotos`);
                const data = await response.json();
                
                if (data.sucesso) {
                    renderizarPilotosEquipe(data.pilotos || []);
                }
                
                // Carregar equipes do piloto (se for piloto)
                const minhasEquipesResponse = await fetch('/api/pilotos/minhas-equipes');
                const minhasEquipesData = await minhasEquipesResponse.json();
                
                if (minhasEquipesData.sucesso) {
                    renderizarMinhasEquipes(minhasEquipesData.equipes || []);
                }
            } catch (error) {
                console.error('Erro ao carregar pilotos:', error);
            }
        }

        function renderizarPilotosEquipe(pilotos) {
            const container = document.getElementById('pilotosLista');
            
            if (!pilotos || pilotos.length === 0) {
                container.innerHTML = '<p class="text-muted small">Nenhum piloto vinculado ainda</p>';
                return;
            }
            
            container.innerHTML = pilotos.map(piloto => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">${piloto.nome}</h6>
                        <small class="text-muted">${piloto.id}</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger" onclick="desvincularPiloto('${piloto.id}')">
                        ‚úï Remover
                    </button>
                </div>
            `).join('');
        }

        function renderizarMinhasEquipes(equipes) {
            const container = document.getElementById('equipesList');
            
            if (!equipes || equipes.length === 0) {
                container.innerHTML = '<p class="text-muted small">Voc√™ ainda n√£o est√° vinculado a nenhuma equipe</p>';
                return;
            }
            
            container.innerHTML = equipes.map(equipe => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">${equipe.nome}</h6>
                        <small class="text-muted">${equipe.id}</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger" onclick="desvincularDeEquipe('${equipe.id}')">
                        ‚úï Sair
                    </button>
                </div>
            `).join('');
        }

        async function gerarCodigoConvite() {
            const equipeId = localStorage.getItem('equipe_id');
            if (!equipeId) {
                alert('Equipe n√£o identificada');
                return;
            }

            try {
                const response = await fetch(`/api/equipes/${equipeId}/gerar-codigo-convite`, {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (data.sucesso) {
                    document.getElementById('codigoMostrado').textContent = data.codigo;
                    document.getElementById('codigoGerado').style.display = 'block';
                    mostrarToast('‚úì C√≥digo gerado com sucesso!', 'success');
                    
                    // Recarregar pilotos
                    setTimeout(() => carregarPilotos(), 500);
                } else {
                    alert('Erro: ' + (data.erro || 'Falha ao gerar c√≥digo'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao gerar c√≥digo de convite');
            }
        }

        function copiarCodigo() {
            const codigo = document.getElementById('codigoMostrado').textContent;
            navigator.clipboard.writeText(codigo).then(() => {
                mostrarToast('‚úì C√≥digo copiado para a √°rea de transfer√™ncia!', 'success');
            });
        }

        async function vincularAEquipe() {
            const codigo = document.getElementById('inputCodigoConvite').value.trim().toUpperCase();
            
            if (!codigo) {
                alert('Digite o c√≥digo de convite');
                return;
            }

            try {
                const response = await fetch('/api/pilotos/vincular-equipe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ codigo })
                });

                const data = await response.json();
                
                if (data.sucesso) {
                    document.getElementById('inputCodigoConvite').value = '';
                    mostrarToast(data.mensagem, 'success');
                    carregarPilotos();
                } else {
                    alert('Erro: ' + (data.erro || 'Falha ao vincular'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao vincular √† equipe');
            }
        }

        async function desvincularPiloto(pilotoId) {
            if (!confirm('Tem certeza que deseja remover este piloto?')) return;
            
            const equipeId = localStorage.getItem('equipe_id');
            
            try {
                const response = await fetch(`/api/pilotos/${pilotoId}/desvincular-equipe/${equipeId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.sucesso) {
                    mostrarToast('‚úì Piloto removido', 'success');
                    carregarPilotos();
                } else {
                    alert('Erro: ' + (data.erro || 'Falha ao remover'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao remover piloto');
            }
        }

        async function desvincularDeEquipe(equipeId) {
            if (!confirm('Tem certeza que deseja sair desta equipe?')) return;
            
            try {
                const pilotoId = localStorage.getItem('usuario_id');
                const response = await fetch(`/api/pilotos/${pilotoId}/desvincular-equipe/${equipeId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.sucesso) {
                    mostrarToast('‚úì Saiu da equipe', 'success');
                    carregarPilotos();
                } else {
                    alert('Erro: ' + (data.erro || 'Falha ao sair'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao sair da equipe');
            }
        }

        // ========== FUN√á√ïES ETAPAS ==========
        async function carregarEtapasEquipe() {
            const equipeId = localStorage.getItem('equipe_id');
            if (!equipeId) return;

            try {
                const response = await fetch(`/api/equipes/${equipeId}/etapas`);
                const data = await response.json();
                renderizarEtapasEquipe(data.etapas || []);
            } catch (error) {
                console.error('Erro ao carregar etapas:', error);
                document.getElementById('etapasContent').innerHTML = '<div class="alert alert-danger">Erro ao carregar etapas</div>';
            }
        }

        function renderizarEtapasEquipe(etapas) {
            const container = document.getElementById('etapasContent');
            
            // Garantir que etapas √© um array
            if (!Array.isArray(etapas)) {
                console.warn('[RENDERIZAR ETAPAS] etapas n√£o √© um array:', etapas);
                etapas = [];
            }
            
            if (etapas.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">Nenhuma etapa dispon√≠vel</div></div>';
                return;
            }

            const hoje = new Date().toISOString().split('T')[0];
            
            // Mapeamento de tipos de participa√ß√£o
            const tiposParticipacao = {
                'dono_vai_andar': 'üë§ Dono da Equipe vai Andar',
                'tenho_piloto': 'üèéÔ∏è Tenho Piloto Particular',
                'precisa_piloto': 'üîç Necessito Piloto'
            };
            
            try {
                container.innerHTML = etapas.map(etapa => {
                    const etapaData = etapa.data_etapa.split(' ')[0];
                    const ehHoje = etapaData === hoje;
                    const jaInscrita = etapa.tipo_participacao !== null;
                    const precisaPiloto = etapa.tipo_participacao === 'precisa_piloto';
                    const tipoParticipacao = tiposParticipacao[etapa.tipo_participacao] || etapa.tipo_participacao;
                    
                    return `
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card ${ehHoje ? 'border-success' : ''}" style="${ehHoje ? 'box-shadow: 0 0 15px rgba(0,255,0,0.3);' : ''} cursor: pointer;" data-etapa-id="${etapa.id}" onclick="event.stopPropagation(); mostrarPitsEtapa('${etapa.id}')">
                                ${ehHoje ? '<div class="badge bg-success position-absolute" style="top: 10px; right: 10px;">üéØ HOJE</div>' : ''}
                                <div class="card-body">
                                    <h6 class="card-title">Etapa ${etapa.numero} - ${etapa.nome}</h6>
                                    <p class="card-text text-muted mb-2">
                                        <small><strong>Data:</strong> ${new Date(etapa.data_etapa).toLocaleDateString('pt-BR')}</small><br>
                                        <small><strong>Hora:</strong> ${etapa.hora_etapa}</small><br>
                                        <small><strong>S√©rie:</strong> ${etapa.serie}</small>
                                    </p>
                                    <div class="mt-3">
                                        ${!jaInscrita ? `
                                            <button type="button" class="btn btn-sm btn-primary w-100" onclick="mostrarOpcoesPart('${etapa.id}')">
                                                Participar
                                            </button>
                                        ` : `
                                            <div class="alert alert-success mb-0 py-2">
                                                <strong>‚úì Inscrita</strong><br>
                                                <small>${tipoParticipacao}</small>
                                            </div>
                                        `}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('[RENDERIZAR ETAPAS] Erro ao renderizar:', error);
                container.innerHTML = '<div class="col-12"><div class="alert alert-danger">Erro ao renderizar etapas</div></div>';
            }
        }

        async function mostrarOpcoesPart(etapaId) {
            const equipeId = localStorage.getItem('equipe_id');
            
            if (!equipeId) {
                alert('‚ùå Equipe n√£o autenticada');
                return;
            }

            try {
                // Buscar carro ativo da equipe
                const carroResponse = await fetch(`/api/equipes/${equipeId}/carro-ativo`);
                const carroData = await carroResponse.json();
                
                if (!carroData.id) {
                    alert('‚ùå Sua equipe n√£o tem um carro ativo!');
                    return;
                }

                // Verificar se o carro tem todas as pe√ßas necess√°rias
                const response = await fetch(`/api/verificar-pecas-carro?carro_id=${carroData.id}&equipe_id=${equipeId}`);
                const data = await response.json();
                
                if (!data.completo) {
                    const pecasFaltando = data.pecas_faltando || [];
                    alert(`‚ùå Seu carro est√° incompleto!\n\nPe√ßas faltando:\n${pecasFaltando.join('\n')}\n\nComplete seu carro na Garagem para participar.`);
                    return;
                }

                // Armazenar etapa_id e carro_id no modal para usar depois
                document.getElementById('modalEtapaIdPart').value = etapaId;
                document.getElementById('modalCarroIdPart').value = carroData.id;
                document.getElementById('equipeIdPart').value = equipeId;
                
                // Abrir modal
                new bootstrap.Modal(document.getElementById('modalOpcoesPart')).show();
            } catch (error) {
                console.error('Erro ao verificar carro:', error);
                alert('‚ùå Erro ao verificar disponibilidade do carro');
                return;
            }
        }

        async function confirmarParticipacao(tipoParticipacao) {
            const etapaId = document.getElementById('modalEtapaIdPart').value;
            const carroId = document.getElementById('modalCarroIdPart').value;
            const equipeId = document.getElementById('equipeIdPart').value;
            
            if (!etapaId || !carroId || !equipeId) {
                alert('Dados inv√°lidos');
                return;
            }

            try {
                const response = await fetch('/api/etapas/equipe/gerar-pix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        etapa_id: etapaId,
                        equipe_id: equipeId,
                        carro_id: carroId,
                        tipo_participacao: tipoParticipacao
                    })
                });

                const data = await response.json();
                
                // Caso 1: Requer regulariza√ß√£o (d√©bito < -valor_etapa)
                if (data.requer_regularizacao) {
                    // Fechar modal de op√ß√µes
                    bootstrap.Modal.getInstance(document.getElementById('modalOpcoesPart')).hide();
                    
                    // Preencher modal de regulariza√ß√£o
                    document.getElementById('regEtapaId').value = etapaId;
                    document.getElementById('regCarroId').value = carroId;
                    document.getElementById('regEquipeId').value = equipeId;
                    document.getElementById('regTipoParticipacao').value = tipoParticipacao;
                    document.getElementById('regValorNecessario').value = data.valor_necessario;
                    
                    document.getElementById('regSaldoAtual').textContent = formatarMoeda(data.saldo_atual);
                    document.getElementById('regValorEtapa').textContent = formatarMoeda(data.valor_etapa);
                    document.getElementById('regValorMostrado').textContent = formatarMoeda(data.valor_necessario);
                    
                    // Mostrar modal de regulariza√ß√£o
                    new bootstrap.Modal(document.getElementById('modalRegularizacaoSaldo')).show();
                    return;
                }
                
                // Caso 2: Escolher forma de pagamento (saldo >= 0)
                if (data.requer_escolha_pagamento) {
                    // Fechar modal de op√ß√µes
                    bootstrap.Modal.getInstance(document.getElementById('modalOpcoesPart')).hide();
                    
                    // Preencher modal de escolha
                    document.getElementById('escolhaEtapaId').value = etapaId;
                    document.getElementById('escolhaCarroId').value = carroId;
                    document.getElementById('escolhaEquipeId').value = equipeId;
                    document.getElementById('escolhaTipoParticipacao').value = tipoParticipacao;
                    document.getElementById('escolhaValorEtapa').value = data.valor_etapa;
                    
                    document.getElementById('escolhaValorMostrado').textContent = formatarMoeda(data.valor_etapa);
                    
                    // Mostrar modal de escolha
                    new bootstrap.Modal(document.getElementById('modalEscolhaPagamento')).show();
                    return;
                }
                
                // Caso 3: Sucesso (sem escolha, j√° inscrito)
                if (data.sucesso) {
                    alert('‚úì Equipe inscrita na etapa!');
                    bootstrap.Modal.getInstance(document.getElementById('modalOpcoesPart')).hide();
                    carregarEtapasEquipe();
                } else {
                    alert('Erro: ' + (data.erro || 'Falha ao inscrever'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao inscrever na etapa');
            }
        }

        async function pagarInscricaoAgora() {
            /**Pagar inscri√ß√£o via PIX agora*/
            const etapaId = document.getElementById('escolhaEtapaId').value;
            const carroId = document.getElementById('escolhaCarroId').value;
            const equipeId = document.getElementById('escolhaEquipeId').value;
            const tipoParticipacao = document.getElementById('escolhaTipoParticipacao').value;
            const valorEtapa = parseFloat(document.getElementById('escolhaValorEtapa').value);
            
            if (!etapaId || !carroId || !equipeId || !valorEtapa) {
                alert('Dados inv√°lidos');
                return;
            }

            try {
                console.log('[INSCRI√á√ÉO PIX] Gerando PIX para inscri√ß√£o...');
                const response = await fetch('/api/etapas/gerar-pix-inscricao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        etapa_id: etapaId,
                        equipe_id: equipeId,
                        carro_id: carroId,
                        tipo_participacao: tipoParticipacao,
                        valor_inscricao: valorEtapa
                    })
                });

                const data = await response.json();
                
                if (data.sucesso) {
                    console.log('[INSCRI√á√ÉO PIX] ‚úÖ PIX gerado:', data.transacao_id);
                    
                    // Fechar modal de escolha
                    const escolhaModal = bootstrap.Modal.getInstance(document.getElementById('modalEscolhaPagamento'));
                    if (escolhaModal) {
                        escolhaModal.hide();
                    }
                    
                    // Obter dados completos do PIX gerado para exibir
                    const pixDataResponse = await fetch(`/api/transacao-pix/${data.transacao_id}`);
                    const pixData = await pixDataResponse.json();
                    
                    if (pixData.sucesso) {
                        // Preparar dados para exibir no modal
                        const dadosPix = {
                            transacao_id: data.transacao_id,
                            item_nome: `Inscri√ß√£o - Etapa ${etapaId}`,
                            valor_item: valorEtapa,
                            taxa: 0.0,
                            valor_total: valorEtapa,
                            qr_code_url: pixData.transacao.qr_code_url,
                            equipe_id: equipeId,
                            etapa_id: etapaId
                        };
                        
                        // Usar fun√ß√£o espec√≠fica para inscri√ß√£o PIX
                        if (typeof mostrarPixModalInscricao === 'function') {
                            mostrarPixModalInscricao(dadosPix);
                        } else {
                            console.error('[INSCRI√á√ÉO PIX] Fun√ß√£o mostrarPixModalInscricao n√£o encontrada');
                            alert('Erro ao exibir QR Code');
                        }
                    } else {
                        alert('Erro ao obter dados do PIX');
                    }
                } else {
                    alert('Erro: ' + (data.erro || 'Falha ao gerar PIX'));
                }
            } catch (error) {
                console.error('[INSCRI√á√ÉO PIX] Erro:', error);
                alert('Erro ao gerar PIX de inscri√ß√£o: ' + error.message);
            }
        }

        async function pagarInscricaoPoster() {
            /**Pagar inscri√ß√£o depois (adiciona ao d√©bito)*/
            const etapaId = document.getElementById('escolhaEtapaId').value;
            const carroId = document.getElementById('escolhaCarroId').value;
            const equipeId = document.getElementById('escolhaEquipeId').value;
            const tipoParticipacao = document.getElementById('escolhaTipoParticipacao').value;
            const valorEtapa = parseFloat(document.getElementById('escolhaValorEtapa').value);
            
            if (!etapaId || !carroId || !equipeId || !valorEtapa) {
                alert('Dados inv√°lidos');
                return;
            }

            try {
                console.log('[INSCRI√á√ÉO D√âBITO] Inscrevendo com d√©bito...');
                const response = await fetch('/api/etapas/inscrever-com-debito', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        etapa_id: etapaId,
                        equipe_id: equipeId,
                        carro_id: carroId,
                        tipo_participacao: tipoParticipacao,
                        valor_inscricao: valorEtapa
                    })
                });

                const data = await response.json();
                
                if (data.sucesso) {
                    console.log('[INSCRI√á√ÉO D√âBITO] ‚úÖ Inscrito com d√©bito');
                    
                    // Fechar modal
                    const escolhaModal = bootstrap.Modal.getInstance(document.getElementById('modalEscolhaPagamento'));
                    if (escolhaModal) {
                        escolhaModal.hide();
                    }
                    
                    mostrarToast('‚úì Inscrito na etapa! O valor ser√° cobrado na pr√≥xima etapa.', 'success');
                    carregarEtapasEquipe();
                } else {
                    alert('Erro: ' + (data.erro || 'Falha ao inscrever'));
                }
            } catch (error) {
                console.error('[INSCRI√á√ÉO D√âBITO] Erro:', error);
                alert('Erro ao inscrever: ' + error.message);
            }
        }

        async function gerarPixRegularizacao() {
            const etapaId = document.getElementById('regEtapaId').value;
            const carroId = document.getElementById('regCarroId').value;
            const equipeId = document.getElementById('regEquipeId').value;
            const tipoParticipacao = document.getElementById('regTipoParticipacao').value;
            const valorRegularizacao = parseFloat(document.getElementById('regValorNecessario').value);
            
            if (!etapaId || !carroId || !equipeId || !valorRegularizacao) {
                alert('Dados inv√°lidos');
                return;
            }

            try {
                console.log('[REGULARIZA√á√ÉO] Gerando PIX de regulariza√ß√£o...');
                const response = await fetch('/api/etapas/gerar-pix-regularizacao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        etapa_id: etapaId,
                        equipe_id: equipeId,
                        carro_id: carroId,
                        tipo_participacao: tipoParticipacao,
                        valor_regularizacao: valorRegularizacao
                    })
                });

                const data = await response.json();
                
                if (data.sucesso) {
                    console.log('[REGULARIZA√á√ÉO] ‚úÖ PIX gerado:', data.transacao_id);
                    
                    // Fechar modal de regulariza√ß√£o
                    const regularizacaoModal = bootstrap.Modal.getInstance(document.getElementById('modalRegularizacaoSaldo'));
                    if (regularizacaoModal) {
                        regularizacaoModal.hide();
                    }
                    
                    // Obter dados completos do PIX gerado para exibir
                    const pixDataResponse = await fetch(`/api/transacao-pix/${data.transacao_id}`);
                    const pixData = await pixDataResponse.json();
                    
                    if (pixData.sucesso) {
                        // Preparar dados para exibir no modal
                        const dadosPix = {
                            transacao_id: data.transacao_id,
                            item_nome: `Regulariza√ß√£o - Etapa ${etapaId}`,
                            valor_item: valorRegularizacao,
                            taxa: 0.0,
                            valor_total: valorRegularizacao,
                            qr_code_url: pixData.transacao.qr_code_url,
                            equipe_id: equipeId,
                            etapa_id: etapaId
                        };
                        
                        // Usar fun√ß√£o espec√≠fica para regulariza√ß√£o
                        if (typeof mostrarPixModalRegularizacao === 'function') {
                            mostrarPixModalRegularizacao(dadosPix);
                        } else {
                            console.error('[REGULARIZA√á√ÉO] Fun√ß√£o mostrarPixModalRegularizacao n√£o encontrada');
                            alert('Erro ao exibir QR Code');
                        }
                    } else {
                        alert('Erro ao obter dados do PIX');
                    }
                } else {
                    alert('Erro: ' + (data.erro || 'Falha ao gerar PIX'));
                }
            } catch (error) {
                console.error('[REGULARIZA√á√ÉO] Erro:', error);
                alert('Erro ao gerar PIX de regulariza√ß√£o: ' + error.message);
            }
        }

        async function marcarprecisaPiloto(etapaId) {
            const equipeId = localStorage.getItem('equipe_id');
            const carro = JSON.parse(localStorage.getItem('carro_selecionado') || '{}');
            
            if (!carro.id) {
                alert('Selecione um carro primeiro na Garagem!');
                return;
            }

            const confirmar = confirm('Marcar que precisa de piloto para esta etapa?');
            if (!confirmar) return;

            try {
                const response = await fetch('/api/etapas/equipe/participar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        etapa_id: etapaId,
                        equipe_id: equipeId,
                        carro_id: carro.id,
                        tipo: 'precisa_piloto'
                    })
                });

                const data = await response.json();
                if (data.sucesso) {
                    alert('‚úì Marcado como necess√°rio piloto!');
                    carregarEtapasEquipe();
                } else {
                    alert('Erro: ' + (data.erro || 'Falha ao marcar'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao marcar necessidade de piloto');
            }
        }
    </script>

    <!-- Modal de Op√ß√µes de Participa√ß√£o -->
    <div class="modal fade" id="modalOpcoesPart" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-danger">
                    <h5 class="modal-title">Como voc√™ vai participar?</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalEtapaIdPart">
                    <input type="hidden" id="modalCarroIdPart">
                    <input type="hidden" id="equipeIdPart">
                    
                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-danger btn-lg" onclick="confirmarParticipacao('dono_vai_andar')">
                            <div class="mb-2">üë§ Dono da Equipe vai Andar</div>
                            <small class="d-block">O dono vai pilotar o carro</small>
                        </button>
                        
                        <button type="button" class="btn btn-warning btn-lg" onclick="confirmarParticipacao('tenho_piloto')">
                            <div class="mb-2">üèéÔ∏è Tenho Piloto Particular</div>
                            <small class="d-block">J√° tenho um piloto definido</small>
                        </button>
                        
                        <button type="button" class="btn btn-info btn-lg" onclick="confirmarParticipacao('precisa_piloto')">
                            <div class="mb-2">üîç Necessito Piloto</div>
                            <small class="d-block">Preciso de um piloto para esta etapa</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Escolha de Pagamento (quando saldo >= 0) -->
    <div class="modal fade" id="modalEscolhaPagamento" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-info">
                    <h5 class="modal-title">üí≥ Op√ß√£o de Pagamento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="escolhaEtapaId">
                    <input type="hidden" id="escolhaCarroId">
                    <input type="hidden" id="escolhaEquipeId">
                    <input type="hidden" id="escolhaTipoParticipacao">
                    <input type="hidden" id="escolhaValorEtapa">
                    
                    <div class="alert alert-info mb-4">
                        <strong>Como voc√™ deseja pagar a inscri√ß√£o?</strong>
                    </div>
                    
                    <div class="card bg-secondary mb-4">
                        <div class="card-body">
                            <small class="text-muted d-block mb-1">Valor da Inscri√ß√£o</small>
                            <h4 class="text-info mb-0" id="escolhaValorMostrado">R$ 0,00</h4>
                        </div>
                    </div>
                </div>
                <div class="modal-footer gap-2">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" onclick="pagarInscricaoPoster()" style="flex: 1;">
                        üí∞ Pagar Depois (D√©bito)
                    </button>
                    <button type="button" class="btn btn-success" onclick="pagarInscricaoAgora()" style="flex: 1;">
                        üí≥ Pagar Agora (PIX)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Regulariza√ß√£o de Saldo -->
    <div class="modal fade" id="modalRegularizacaoSaldo" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-warning">
                    <h5 class="modal-title">‚ö†Ô∏è Saldo Insuficiente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="regEtapaId">
                    <input type="hidden" id="regCarroId">
                    <input type="hidden" id="regEquipeId">
                    <input type="hidden" id="regTipoParticipacao">
                    <input type="hidden" id="regValorNecessario">
                    
                    <div class="alert alert-warning mb-4">
                        <strong>üí∞ Voc√™ possui d√©bito de participa√ß√£o anterior!</strong>
                    </div>
                    
                    <div class="card bg-secondary mb-4">
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <small class="text-muted d-block mb-1">Saldo Atual</small>
                                    <h6 class="text-danger mb-0" id="regSaldoAtual">-</h6>
                                </div>
                                <div class="col-6 text-end">
                                    <small class="text-muted d-block mb-1">Valor da Etapa</small>
                                    <h6 class="mb-0" id="regValorEtapa">-</h6>
                                </div>
                            </div>
                            <hr class="bg-light my-3">
                            <div class="text-center">
                                <small class="text-muted d-block mb-1">Valor Necess√°rio para Participar</small>
                                <h4 class="text-warning mb-0" id="regValorMostrado">R$ 0,00</h4>
                                <small class="text-info d-block mt-2">Ap√≥s pagamento, voc√™ ser√° automaticamente inscrito</small>
                            </div>
                        </div>
                    </div>
                    
                    <p class="text-muted text-center mb-0">
                        <small>Para participar desta etapa, voc√™ precisa regularizar seu saldo clicando no bot√£o abaixo</small>
                    </p>
                </div>
                <div class="modal-footer gap-2">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning btn-lg" onclick="gerarPixRegularizacao()" style="flex: 1;">
                        üí≥ Gerar PIX para Regularizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='script.js', v=1708537200) }}"></script>
    <script src="{{ url_for('static', filename='qualificacao.js') }}"></script>
    <script src="{{ url_for('static', filename='sistema_notificacao.js') }}"></script>

    <!-- Verificar URL para abrir evento automaticamente ap√≥s login -->
    <script>
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const etapaId = urlParams.get('etapa');
            
            if (etapaId) {
                console.log('[AUTO-EVENTO] Abrindo evento para etapa:', etapaId);
                
                // Aguardar um pouco para garantir que tudo est√° carregado
                setTimeout(() => {
                    // Tentar chamar a fun√ß√£o mostrarEventoAoVivo
                    if (typeof mostrarEventoAoVivo === 'function') {
                        console.log('[AUTO-EVENTO] Fun√ß√£o dispon√≠vel, abrindo modal...');
                        mostrarEventoAoVivo(etapaId);
                    } else {
                        console.warn('[AUTO-EVENTO] Fun√ß√£o mostrarEventoAoVivo ainda n√£o est√° dispon√≠vel');
                    }
                }, 500);
                
                // Limpar URL para n√£o reabrir o modal ao atualizar
                window.history.replaceState({}, document.title, '/dashboard');
            }
        });
    </script>
</body>
</html>
