{% extends "admin_base.html" %}
{% block title %}GRANPIX - Histórico PIX{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Total de Equipes</div>
        <div class="stat-value" id="totalEquipes">-</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Solicitações de Peça</div>
        <div class="stat-value" id="solicitacoesPecasPendentes">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Solicitações de Carro</div>
        <div class="stat-value" id="solicitacoesCarrosPendentes">0</div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center flex-wrap gap-2">
          <h5 class="mb-0"><i class="fas fa-qrcode me-2"></i>Histórico de PIX dos Pilotos</h5>
          <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="filtroStatus" style="width: auto;">
              <option value="">Todos os status</option>
              <option value="aprovado">Aprovado</option>
              <option value="pendente">Pendente</option>
              <option value="recusado">Recusado</option>
              <option value="cancelado">Cancelado</option>
            </select>
            <select class="form-select form-select-sm" id="filtroMes" style="width: auto;">
              <option value="">Todos os períodos</option>
              <option value="este_mes">Este mês</option>
            </select>
            <button type="button" class="btn btn-sm btn-outline-light" id="btnAtualizar"><i class="fas fa-sync-alt"></i> Atualizar</button>
          </div>
        </div>
        <div class="card-body">
          <div id="listaPix" class="table-responsive">
            <p class="text-muted">Carregando histórico...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="toast-container"></div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
window.addEventListener('load', () => {
  atualizarStatusAdmin();
  atualizarContadoresSolicitacoes && atualizarContadoresSolicitacoes().catch(e => console.error('Erro ao atualizar contadores:', e));
  carregarHistoricoPix();
});

document.getElementById('btnAtualizar')?.addEventListener('click', carregarHistoricoPix);
document.getElementById('filtroStatus')?.addEventListener('change', carregarHistoricoPix);
document.getElementById('filtroMes')?.addEventListener('change', carregarHistoricoPix);

function descricaoTipo(tipo) {
  const map = {
    'instalacao_armazem': 'Instalação peça (armazém)',
    'warehouse': 'Armazém',
    'peca': 'Peça',
    'carro': 'Carro',
    'carro_ativacao': 'Ativação de carro',
    'participacao_etapa': 'Participação etapa',
    'regularizacao': 'Regularização de saldo',
    'inscricao_etapa': 'Inscrição etapa',
    'instalar_peca': 'Instalação peça',
    'compra_carro': 'Compra de carro',
    'compra_peca': 'Compra de peça'
  };
  return map[tipo] || (tipo || 'PIX');
}

function badgeStatus(status) {
  const classes = { aprovado: 'bg-success', pendente: 'bg-warning', recusado: 'bg-danger', cancelado: 'bg-secondary' };
  return classes[status] || 'bg-secondary';
}

async function carregarHistoricoPix() {
  const container = document.getElementById('listaPix');
  const status = document.getElementById('filtroStatus')?.value || '';
  const mes = document.getElementById('filtroMes')?.value || '';
  try {
    const params = new URLSearchParams();
    if (status) params.set('status', status);
    if (mes) params.set('mes', mes);
    const resp = await fetch('/api/admin/transacoes-pix?' + params.toString());
    const data = await resp.json();
    if (data.erro) {
      container.innerHTML = '<p class="text-danger">Erro: ' + (data.erro || 'Erro ao carregar') + '</p>';
      return;
    }
    const transacoes = data.transacoes || data.comissoes || [];
    if (!transacoes.length) {
      container.innerHTML = '<p class="text-muted">Nenhum PIX registrado ainda.</p>';
      return;
    }
    let html = '<table class="table table-hover table-striped mb-0"><thead><tr><th>Data</th><th>Equipe / Piloto</th><th>Tipo</th><th>Descrição</th><th class="text-end">Valor</th><th>Status</th></tr></thead><tbody>';
    transacoes.forEach(t => {
      const valorTotal = (t.valor_total != null ? parseFloat(t.valor_total) : (parseFloat(t.valor_item || 0) + parseFloat(t.valor_taxa || 0)));
      const dataStr = t.data_transacao || t.data_criacao ? new Date(t.data_transacao || t.data_criacao).toLocaleString('pt-BR') : '-';
      const descricao = t.item_nome ? t.item_nome : descricaoTipo(t.tipo || t.tipo_item);
      html += `<tr><td>${dataStr}</td><td>${t.equipe_nome || '-'}</td><td>${descricaoTipo(t.tipo || t.tipo_item)}</td><td>${descricao}</td><td class="text-end">R$ ${valorTotal.toFixed(2)}</td><td><span class="badge ${badgeStatus(t.status)}">${(t.status || 'pendente')}</span></td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) {
    console.error('Erro ao carregar histórico PIX:', e);
    container.innerHTML = '<p class="text-danger">Erro de conexão ao carregar histórico.</p>';
  }
}

async function atualizarStatusAdmin() {
  try { const resp = await fetch('/api/admin/status'); const status = await resp.json(); document.getElementById('totalEquipes').textContent = status.total_equipes || 0; } catch (e) {}
}

async function atualizarContadoresSolicitacoes() {
  if (typeof window.atualizarContadoresSolicitacoesAdmin === 'function') return window.atualizarContadoresSolicitacoesAdmin();
  try {
    const respPecas = await fetch('/api/admin/solicitacoes-pecas');
    const pecas = await respPecas.json();
    const pecasPendentes = Array.isArray(pecas) ? pecas.filter(s => s.status === 'pendente').length : 0;
    const elemPecas = document.getElementById('solicitacoesPecasPendentes');
    if (elemPecas) elemPecas.textContent = pecasPendentes;
    const respCarros = await fetch('/api/admin/solicitacoes-carros');
    const carros = await respCarros.json();
    const carrosPendentes = Array.isArray(carros) ? carros.filter(s => s.status === 'pendente').length : 0;
    const elemCarros = document.getElementById('solicitacoesCarrosPendentes');
    if (elemCarros) elemCarros.textContent = carrosPendentes;
  } catch (e) { console.error('Erro ao atualizar contadores de solicitações:', e); }
}
</script>
{% endblock %}
