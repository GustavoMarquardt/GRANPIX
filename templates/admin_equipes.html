{% extends "admin_base.html" %}
{% block title %}GRANPIX - Cadastrar Equipes{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Total de Equipes</div>
        <div class="stat-value" id="totalEquipes">-</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Solicitações de Peça</div>
        <div class="stat-value" id="solicitacoesPecasPendentes">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Solicitações de Carro</div>
        <div class="stat-value" id="solicitacoesCarrosPendentes">0</div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">Nova Equipe</h5>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>Nome da Equipe</label>
            <input type="text" class="form-control" id="equipeNome" placeholder="Ex: Team Ferrari">
          </div>
          <div class="form-group">
            <label>Doricoins Iniciais</label>
            <input type="number" class="form-control" id="equipeDoricoins" placeholder="Ex: 10000" value="10000" step="1">
          </div>
          <div class="form-group">
            <label>Série</label>
            <select class="form-control" id="equipeSerie" required>
              <option value="">Selecione a série...</option>
              <option value="A">Série A</option>
              <option value="B">Série B</option>
            </select>
          </div>
          <div class="form-group">
            <label>Carro Inicial (opcional)</label>
            <select class="form-control" id="equipeCarroSelecionado">
              <option value="">Sem carro (garagem vazia)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Senha de Acesso</label>
            <input type="text" class="form-control" id="equipeSenha" placeholder="Ex: 123456" value="123456">
          </div>
          <button class="btn btn-primary w-100" type="button" onclick="window.cadastrarEquipe()">Criar Equipe</button>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">Equipes Cadastradas</h5>
        </div>
        <div class="card-body" id="listaEquipesCadastro" style="max-height: 500px; overflow-y: auto;">
          <p class="text-muted">Carregando...</p>
        </div>
      </div>
    </div>
  </div>
  <div class="toast-container"></div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
(function() {
  let intervaloSolicitacoesPecas = null, intervaloSolicitacoesCarros = null, intervaloContadores = null;
  let abaSolicitacoesPecasAtiva = true, abaSolicitacoesCarrosAtiva = false;

  function temModalAbertoAdmin() { return document.querySelectorAll('.modal.show').length > 0; }
  function iniciarAutoRefreshAdmin() {
    intervaloSolicitacoesPecas = setInterval(() => { if (abaSolicitacoesPecasAtiva && !document.hidden && !temModalAbertoAdmin()) carregarSolicitacoes && carregarSolicitacoes(); }, 3000);
    intervaloSolicitacoesCarros = setInterval(() => { if (abaSolicitacoesCarrosAtiva && !document.hidden && !temModalAbertoAdmin()) carregarSolicitacoesCarros && carregarSolicitacoesCarros(); }, 3000);
    intervaloContadores = setInterval(() => { if (!document.hidden && !temModalAbertoAdmin()) atualizarContadoresSolicitacoes && atualizarContadoresSolicitacoes().catch(()=>{}); }, 3000);
  }

  window.addEventListener('load', () => {
    atualizarStatusAdmin();
    atualizarContadoresSolicitacoes && atualizarContadoresSolicitacoes().catch(e => console.error('Erro ao atualizar contadores:', e));
    carregarEquipesCadastro && carregarEquipesCadastro();
    carregarCarrosPraEquipe && carregarCarrosPraEquipe();
    iniciarAutoRefreshAdmin();
  });

  async function atualizarStatusAdmin() {
    try { const resp = await fetch('/api/admin/status'); const status = await resp.json(); document.getElementById('totalEquipes').textContent = status.total_equipes || 0; } catch (e) {}
  }

  async function atualizarContadoresSolicitacoes() {
    if (typeof window.atualizarContadoresSolicitacoesAdmin === 'function') return window.atualizarContadoresSolicitacoesAdmin();
    try {
      const respPecas = await fetch('/api/admin/solicitacoes-pecas');
      const pecas = await respPecas.json();
      const pecasPendentes = Array.isArray(pecas) ? pecas.filter(s => s.status === 'pendente').length : 0;
      const elemPecas = document.getElementById('solicitacoesPecasPendentes');
      if (elemPecas) elemPecas.textContent = pecasPendentes;
      const respCarros = await fetch('/api/admin/solicitacoes-carros');
      const carros = await respCarros.json();
      const carrosPendentes = Array.isArray(carros) ? carros.filter(s => s.status === 'pendente').length : 0;
      const elemCarros = document.getElementById('solicitacoesCarrosPendentes');
      if (elemCarros) elemCarros.textContent = carrosPendentes;
    } catch (e) { console.error('Erro ao atualizar contadores:', e); }
  }
})();
</script>
{% endblock %}
