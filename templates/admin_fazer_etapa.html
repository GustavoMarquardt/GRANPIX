{% extends "admin_base.html" %}
{% block title %}GRANPIX - Fazer Etapa{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Total de Equipes</div>
        <div class="stat-value" id="totalEquipes">-</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">SolicitaÃ§Ãµes de PeÃ§a</div>
        <div class="stat-value" id="solicitacoesPecasPendentes">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">SolicitaÃ§Ãµes de Carro</div>
        <div class="stat-value" id="solicitacoesCarrosPendentes">0</div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">Fazer Etapa - QualificaÃ§Ã£o</h5>
        </div>
        <div class="card-body">
          <div id="semEtapaHoje" style="display: block; text-align: center; padding: 40px;">
            <h4 style="color: #666;">Nenhuma etapa programada para hoje</h4>
            <p style="color: #999;">Verifique o calendÃ¡rio de etapas ou aguarde a prÃ³xima programaÃ§Ã£o.</p>
          </div>
          <div id="infoEtapaHoje" style="display: none;">
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="card bg-dark text-white">
                  <div class="card-body">
                    <h6 class="card-title">ğŸ† Campeonato</h6>
                    <p class="card-text" id="etapaHojeCampeonatoNome">-</p>
                    <small class="text-muted">SÃ©rie: <span id="etapaHojeCampeonatoSerie">-</span></small>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card bg-dark text-white">
                  <div class="card-body">
                    <h6 class="card-title">ğŸ“… Etapa</h6>
                    <p class="card-text">Etapa <span id="etapaHojeNumero">-</span>: <span id="etapaHojeNome">-</span></p>
                    <small class="text-muted">HorÃ¡rio: <span id="etapaHojeHora">-</span></small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div id="grupoEtapa" style="display: none;">
            <div class="text-center mb-4">
              <button id="botaoIniciarQualificacao" class="btn btn-success btn-lg" type="button" onclick="window.iniciarQualificacao()">ğŸš€ Iniciar QualificaÃ§Ã£o</button>
              <input type="hidden" id="etapaIdAtual" value="">
            </div>
          </div>
          <div id="containerVoltasAdmin" style="display: none;">
            <h5 class="text-center mb-3" style="color: #dc3545; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">ğŸ“Š Tabela de QualificaÃ§Ã£o - AdministraÃ§Ã£o</h5>
            <div id="tabelaVoltasAdmin" style="max-height: 600px; overflow-y: auto; border: 3px solid #dc3545; border-radius: 8px; background: #fff;"></div>
            <div class="text-center mt-4">
              <button id="botaoFinalizarQualificacao" class="btn btn-danger btn-lg" type="button" onclick="window.finalizarQualificacao()" style="display: none;">ğŸ Finalizar QualificaÃ§Ã£o</button>
            </div>
          </div>
          <div id="secaoResultadoQualificacao" style="display: none;" class="mt-4">
            <h5 class="mb-3" style="color: #ffc107; font-weight: bold;">ğŸ“Š Resultado da QualificaÃ§Ã£o</h5>
            <div id="listaResultadoQualificacao"></div>
          </div>
          <div id="secaoChaveamentoBatalhas" style="display: none;" class="mt-4">
            <h5 class="mb-3" style="color: #ffc107; font-weight: bold;">âš”ï¸ Chaveamento das Batalhas</h5>
            <div id="chaveamentoBatalhasInline" style="overflow-x: auto; overflow-y: auto; padding: 12px; background: #1a1a1a; border-radius: 8px; border: 2px solid #ffc107; min-height: 200px; max-height: 70vh;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="toast-container"></div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
window.addEventListener('load', () => {
  atualizarStatusAdmin();
  atualizarContadoresSolicitacoes && atualizarContadoresSolicitacoes().catch(e => console.error('Erro ao atualizar contadores:', e));
  const params = new URLSearchParams(window.location.search);
  const etapaIdParam = params.get('etapa_id');
  if (etapaIdParam) {
    fetch('/api/etapas/' + encodeURIComponent(etapaIdParam) + '/evento')
      .then(r => r.json())
      .then(data => {
        if (data.sucesso && data.evento && data.evento.etapa) {
          const etapa = data.evento.etapa;
          etapa.id = etapaIdParam;
          if (typeof preencherEtapaHoje === 'function') preencherEtapaHoje(etapa);
          if (typeof verificarStatusEtapa === 'function') verificarStatusEtapa(etapaIdParam);
        } else {
          carregarEtapaHoje && carregarEtapaHoje().catch(e => console.error('Erro ao carregar etapa hoje:', e));
        }
      })
      .catch(() => carregarEtapaHoje && carregarEtapaHoje().catch(e => console.error('Erro ao carregar etapa hoje:', e)));
  } else {
    carregarEtapaHoje && carregarEtapaHoje().catch(e => console.error('Erro ao carregar etapa hoje:', e));
  }
});

async function iniciarQualificacao() {
  const etapaId = document.getElementById('etapaIdAtual').value;
  if (!etapaId) { if (typeof mostrarToast === 'function') mostrarToast('âŒ Nenhuma etapa selecionada', 'error'); else alert('Nenhuma etapa selecionada'); return; }
  await (typeof abrirQualificacao === 'function' ? abrirQualificacao(etapaId) : Promise.resolve());
}
window.iniciarQualificacao = iniciarQualificacao;

async function atualizarStatusAdmin() {
  try { const resp = await fetch('/api/admin/status'); const status = await resp.json(); document.getElementById('totalEquipes').textContent = status.total_equipes || 0; } catch (e) {}
}

async function atualizarContadoresSolicitacoes() {
  if (typeof window.atualizarContadoresSolicitacoesAdmin === 'function') return window.atualizarContadoresSolicitacoesAdmin();
  try {
    const respPecas = await fetch('/api/admin/solicitacoes-pecas');
    const pecas = await respPecas.json();
    const pecasPendentes = Array.isArray(pecas) ? pecas.filter(s => s.status === 'pendente').length : 0;
    const elemPecas = document.getElementById('solicitacoesPecasPendentes');
    if (elemPecas) elemPecas.textContent = pecasPendentes;
    const respCarros = await fetch('/api/admin/solicitacoes-carros');
    const carros = await respCarros.json();
    const carrosPendentes = Array.isArray(carros) ? carros.filter(s => s.status === 'pendente').length : 0;
    const elemCarros = document.getElementById('solicitacoesCarrosPendentes');
    if (elemCarros) elemCarros.textContent = carrosPendentes;
  } catch (e) { console.error('Erro ao atualizar contadores:', e); }
}
</script>
{% endblock %}
